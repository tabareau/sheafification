\documentclass[notfinal]{jfrarticle}

% Begin personal macros

\usepackage{amsmath}

\usepackage[utf8]{inputenc}
\usepackage[T1]{fontenc}
\usepackage{lmodern}
\usepackage{xspace}
\usepackage{url}
\usepackage[colorlinks=false]{hyperref}

% \usepackage[moderate]{savetrees}
% \usepackage{mathptmx}
% \usepackage[scaled=.90]{helvet}
% \usepackage{courier}

% *** MATH PACKAGES ***
%
%\usepackage[cmex10]{amsmath}
\usepackage{wasysym}
\usepackage{amssymb,amsfonts}
\usepackage{mathbbol}
\usepackage{microtype}%if unwanted, comment out or use option "draft"

%\graphicspath{{./graphics/}}%helpful if your graphic files are in another directory

\usepackage[all]{xy}
\def\dar[#1]#2{\ar@<-#2>[#1]\ar@<#2>[#1]} %double arrows in xy
\def\tar[#1]#2{\ar@<#2>[#1]\ar@<0pt>[#1]\ar@<-#2>[#1]} %triple arrows in xy
\DeclareMathOperator{\Type}{Type}
\DeclareMathOperator{\HProp}{HProp}
\DeclareMathOperator{\HSet}{HSet}
\DeclareMathOperator{\IsHProp}{IsHProp}
\DeclareMathOperator{\IsHSet}{IsHSet}
\DeclareMathOperator{\nat}{nat}
\DeclareMathOperator{\Unit}{Unit}
\DeclareMathOperator{\im}{Im}
\DeclareMathOperator{\id}{id}
\DeclareMathOperator{\Contr}{Contr}
\DeclareMathOperator{\IsContr}{IsContr}
\DeclareMathOperator{\IsEquiv}{IsEquiv}
\DeclareMathOperator{\precompose}{\mathrm{precompose}}
\DeclareMathOperator{\postcompose}{\mathrm{postcompose}}
\DeclareMathOperator{\idmap}{\mathrm{idmap}}
\DeclareMathOperator{\cocone}{cocone}
\DeclareMathOperator{\inl}{inl}
\DeclareMathOperator{\inr}{inr}
\DeclareMathOperator{\transport}{transport}
\DeclareMathOperator{\tr}{tr}
\DeclareMathOperator{\Sym}{Sym}
\DeclareMathOperator{\Trans}{Trans}
\DeclareMathOperator{\Refl}{Refl}


\newcommand \defeq {\overset{de\hspace{-0.2ex}f}{=}}

\def\mymathhyphen{{\hbox{-}}}

\newcommand{\IsType}[1]
{\mathop{\mathrm{Is\mymathhyphen}#1\mathrm{\mymathhyphen type}} }

\newcommand{\modal}{\ensuremath{\ocircle}}
\newcommand \True {\top}
\newcommand \idpath {\mathrm{idpath}}
\newcommand \False {\bot}
\newcommand \closure[1] {\overline{#1}}
\newcommand \Char[1] {\chi_{#1}}%{\mathrm{char}(#1)}
\newcommand \E {\mathcal{E}}
\newcommand \Hom[1] {\mathrm{Hom}_{#1}}
\newcommand \Obj {\mathrm{Obj}}
\newcommand \Sh[1] {\mathrm{Sh}_{#1}}
\newcommand \squash[1] {\| #1 \| }
\newcommand \separated {\mathop{\square_{n+1}} }
\newcommand \fib[2] {\mathrm{fib}_{#1}(#2)}
\newcommand \colim {\mathrm{colim}}
\newcommand \zero {\mathbf{0}}
\newcommand \one {\mathbf{1}}
\newcommand \unittt{\star}
\newcommand \two {\mathbf{2}}
\newcommand{\sumD}[3]{\sum_{#1:#2}\, #3}
\newcommand{\prodD}[3]{\prod_{#1:#2}\, #3}
\newcommand{\homot}{\sim}
\newcommand{\retr}{\mathrm{retr}}
\newcommand{\sect}{\mathrm{sect}}
\newcommand{\adj}{\mathrm{adj}}
\newcommand{\ap}[1]{\mathrm{ap}_{#1}}
\newcommand{\inv}[1]{#1^{-1}}
\newcommand{\concat}[2]{#1\cdot #2}
\newcommand{\happly}{\mathrm{happly}}
\newcommand{\Sone}{\mathbb{S}^1}
\newcommand{\baseS}{\mathrm{base}}
\newcommand{\loopS}{\mathrm{loop}}
\newcommand{\coeq}[2]{\mathrm{Coeq}^{#1,#2}}

\newcommand{\code}[1]{\texttt{#1}}

\DeclareMathOperator{\issep}{IsSeparated}
\DeclareMathOperator{\issheaf}{IsSheaf}
\DeclareMathOperator{\KP}{KP}
\DeclareMathOperator{\kp}{kp}

	% Ensembles %
\newcommand{\N}{\mathbb{N}} %entiers naturels

        % Flèches %
\newcommand{\To}{\Rightarrow}
\newcommand{\ot}{\leftarrow}
\newcommand{\oT}{\Leftarrow}
\newcommand{\tot}{\leftrightarrow}
\newcommand{\ToT}{\Leftrightarrow}
\newcommand{\cto}{\hookrightarrow}
%\newcommand{\cot}{\hookleftarrow}



	% Fonctions %
\newcommand{\fonction}[5]{ %{nom de la fonction}{ensemble de dÃ©part}{ensemble d'arrivÃ©e}{nom de la variable}{image de la variable}
	#1 \, \colon \left.
	 \begin{array}{ccl}
		#2 & \longrightarrow & #3 \\
		#4 & \longmapsto & #5
	\end{array}
	\right.
}

\newcommand{\ie}{\emph{i.e.}}
\newcommand{\eg}{\emph{e.g.}}
\newcommand{\etc}{\emph{etc.}}


% End

% syntax: \title[short title]{very very very very long title}
% the long title is mandatory and will appear in the title page
% the short title is optional and is used inside the headings; if it is not specified, the long title will be
% used instead
\title{Lawvere-Tierney sheafification in Homotopy Type Theory}

% syntax: \author{short authors}{full authors}
% the first parameter is the list of the (first) authors and is used inside the headings; 
% the second one is the full list of authors, including their affiliations, and is shown in the title page
\author{K. Quirin and N. Tabareau}
{Kevin Quirin\\ \'{E}cole des Mines de Nantes, France
  \and
  Nicolas Tabareau\\Inria, France}

\begin{abstract}
  Sheafification is a popular tool in topos theory which
  allows the extension of the internal logic of a topos with new
  principles. One of its most famous applications is the transformation
  of a given topos into a boolean topos using the
  dense topology, a construction which corresponds in essence to Gödel's double
  negation translation.
  % 
  The same construction has not yet been developed in Martin-Löf type
  theory due to a mismatch between topos theory and type theory. This
  mismatch has been fixed recently by the introduction of homotopy type
  theory, an extension of Martin-Löf type theory with new
  principles inspired by category theory and homotopy theory, and
  corresponding closely with the theory of higher toposes.
  % 
  In this paper, we give a computer-checked construction of
  Lawvere-Tierney sheafification in homotopy type theory.
\end{abstract}

\begin{document}

\newtheorem{thm}{Theorem}[section]
\newtheorem{prop}[thm]{Proposition}%[section]
\newtheorem{lem}[thm]{Lemma}%[section]
\newdef{rmq}[thm]{Remark}%[section]
\newdef{cond}[thm]{Condition}%[section]
\newdef{defi}[thm]{Definition}%[section]

%sets the number of the first page
%\setcounter{page}{111} 

\begin{bottomstuff}

The bottom of the article's title page contains acknowledgment of
support, the author(s) address(es), a ``permission to copy'' statement,
and a line containing a copyright symbol (\copyright) and a mysterious
number.  This is all entered with a {\tt bottomstuff} environment;
there must be no blank line after the \verb|\begin{bottomstuff}|
command.  The permission to copy statement is produced by the
\verb|\permission| command.
\permission
\copyright\ 2008 Journal of Formal Reasoning
\end{bottomstuff}

\maketitle

\section{Introduction}


Sheafification~\cite{maclanemoerdijk} is a very powerful geometric
construction which arose initially in topology and algebraic geometry but which,
nonetheless, quickly found important applications to mathematical logic.
%
In topos theory, sheafification can be seen as a way to transform one
topos into another. It is used, for example, to build, from any topos
$\mathcal T$, a boolean topos (\ie{} one which validates the excluded
middle principle) satisfying the axiom of choice and negating the
continuum hypothesis~\cite[Theorem VI.2.1]{maclanemoerdijk}.  This is,
in fact, an adaptation of a slightly older set theoretic method called
{\em forcing} which transforms a model $\mathfrak M$ of ZFC into a
model $\mathfrak M[G]$ of ZFC, satisfying new principles. Its most
famous application is the proof of consistency of ZFC with the
negation of the continuum hypothesis by Paul Cohen~\cite{cohen1966},
answering (neither negatively nor positively) Hilbert's first
problem. Indeed, Gödel proved in 1938 the consistency of ZFC with
continuum hypothesis~\cite{godel1938} using the constructible model
$\mathfrak L$.  The central idea of forcing is to add to the
theory ZFC partial information about the witness of $\lnot$CH.  Then,
supposing that ZFC is coherent, it is provable that ZFC together with
a finite number of approximation of the desired object is still
consistent. Finally, the compactness theorem allows one to prove the
consistency of ZFC with {\em all} approximations, \ie{} with a witness
of $\lnot$CH.

Subsequently, forcing was adapted to topos theory by Myles
Tierney~\cite{tierney1972} making use of the notion of sheaves.
Note that, in topos theory, there are two different kind of sheaves:
Grothendieck sheaves, which only exist on a presheaf topos, and
Lawvere-Tierney sheaves. One can show that Lawvere-Tierney sheaves,
when considered on a presheaf topos, are exactly the Grothendieck
sheaves; thus, Lawvere-Tierney sheaves can be seen as a generalization
of Grothendieck sheaves.  Given a topos $\mathcal T$, one can build
another topos -- the topos of sheaves $\Sh{}(\mathcal T)$ -- together
with a geometric embedding from $\Sh{}(\mathcal T)$ to $\mathcal T$
whose left adjoint is called {\em sheafification}.  Depending on the
sheaves we choose to treat, the topos $\Sh{}(\mathcal T)$ may satisfy new
principles. The construction of the geometric embedding is done in
\cite[Section V.3]{maclanemoerdijk}, and briefly recalled in
section~\ref{sec:sheaf_topos}.

Type theory is known to have a close relationship with topos theory,
prompting one to wonder if similar techniques might not be developed for
type theory.
%
The answer to this question has been given recently by the advent of
homotopy type theory~\cite{hottbook}, an extension of
Martin-Löf type theory with principles inspired by (higher) category
theory and homotopy theory, such as higher inductive
types~\cite{lumsdaine2013higher,hottbook} and
Voevodsky's univalence principle~\cite{kapulkin2012simplicial}, which
says that for any types $T$ and $U$, the canonical map 
$$
(T = U) \to (T \simeq U)
$$ 
%
transporting equalities to equivalences, is itself an equivalence.
%
This new point of view on type theory has revealed how types
carry homotopical structure. For instance, mere propositions (or
$\Type_{-1}$) are just types with an
irrelevant equality and sets (or $\Type_{0}$) are types
with a propositional equality and so on for $\Type_{n}$.
%
The development of univalence has also shed some light on the
difficulty of making AC and EM coexist in type theory. Indeed, it
has been shown that a naive (non-propositional) version of EM is
inconsistent with univalence.

When restricted to mere propositions and sets, homotopy type
theory corresponds quite closely to topos theory but the mismatch
starts when considering higher homotopy types.
%
Fortunately, a higher version of topos theory has been developed
recently, synthesized in the monograph of Lurie on
higher topos theory~\cite{lurie}. Even if the connection between 
homotopy type theory and higher topos theory has not yet been made
perfectly precise, it is commonly believed that the former constitutes an internal
language for the latter (see \cite{shulman2015} for a more detail
discussion on this topic). 

Lurie has adapted a considerable number of the tools of topos theory
to a higher setting. In particular, the theory of sheaves has been
lifted to higher topos theory.
%
As the notion of higher topos appears to correspond very closely to
homotopy type theory, this provides a new hope that tackling the
problem of extending the power of homotopy type theory using
sheafification is actually possible.

Nevertheless, the adaptation of the sheafification in higher topos
theory to homotopy type theory is not completely straightforward because the
construction in higher toposes is restricted to the initial Grothendieck
setting which is still very topologically oriented, and hence not very
amenable to formalization in type theory. It seems more promising to
use a synthetic notion of sheafification, called Lawvere-Tierney
sheafification~\cite{tierney1972sheaf,maclanemoerdijk}, but this construction has not
been considered yet in the setting of higher topos theory. This raises
two issues that this paper addresses: (i) how to lift the notion of
Lawvere-Tierney sheafification to higher topos theory and (ii) whether is it
possible to formalize this new definition in homotopy type theory.


% The development of higher topos theory (and more generally, higher
% category theory) leads to wonder if a notion of sheafification still
% exists in this setting. This question is answered positively
% in~\cite{lurie}, where the author builds a sheafification functor, but
% only for Grothendieck sheaves. Surprisingly, sheafification in a
% higher topos is just an iteration of the process of sheafification in
% topos theory. 

This paper presents a definition of the sheafification functor in the
setting of homotopy type theory. As Lawvere-Tierney sheaves have not, to
our knowledge, been considered in the higher setting, the contribution
of this article is twofold: (i) we propose a construction which
coincides with Lawvere-Tierney sheafification when restricted to hSets
by connecting it to the work on higher modalities~\cite{hottbook},
(ii) we formalize all the definitions and theorems internally inside
the Coq proof assistant~\cite{Coq:manual}.

\subsection*{Plan of the paper}

Section~\ref{sec:hott} introduces the necessary preliminaries on
Homotopy Type Theory while Section~\ref{sec:modalities} presents the
version of higher modalities that we
use. Section~\ref{sec:sheaf_topos} recalls the definition of
sheafification in toposes. Section \ref{sec:sheaf_hott} presents the
main contribution of this article, the definition of sheafification in
Homotopy Type Theory, and Section \ref{sec:sheaf-formalization}
discusses its formalization inside the Coq proof assistant. 

\subsection*{Related Work}

Similar questions have been considered in relation to the Curry-Howard
isomorphism, that is, the possibility of extending a programming
language close to type theory with new logical or computational
principles while keeping consistency automatically.
%
For instance, much effort has been invested in providing a computational
content for the law of excluded middle in order to define a
constructive version of classical logic. This has lead to various
calculi, most notably the $\lambda \mu$-calculus of
Parigot~\cite{parigot1993classical}. However, this line of work has not
appeared to be fruitful in defining a new version of type theory with
classical principles.
%
Other authors have tried to extend the continuation-passing-style (CPS)
transformation to type theory.  They have been faced, however, with the
difficulty that the CPS transformation is incompatible with (full) dependent
sums~\cite{barthe2002cps}, emphasizing the fragile link
between the axiom of choice and the law of excluded middle in type theory.
%
Nevertheless the axiom of choice has been shown to be realizable by
computational meaning in a classical setting by techniques turning
around the notion of (modified) bar induction
\cite{berardi1998computational}, Krivine's
realizability~\cite{krivine2003dependent} and even more recently with
restriction on elimination of dependent sums and lazy
evaluation~\cite{herbelin2012constructive}.
The work on forcing in type theory~\cite{jaber2012extending,forcing2016} also
gives a computational meaning to a type theory enriched with new
logical or computational principles.
%
Actually, this construction is entirely complementary to
forcing in type theory, as forcing corresponds to the presheaf
construction while Lawvere-Tierney sheafification corresponds to the
topological transformation that allows the passage from the presheaf
construction to the sheaf construction.




\section{Preliminaries on Homotopy Type Theory}
\label{sec:hott}

In this section, we review some basic definitions in homotopy type
theory which will be central to our formalization but not specific to
sheafification. 
% %
% Section~\ref{ssec:hott} introduces the notion of homotopy types and
% classifying objects as defined in~\cite{sets_in_hott}.
% %
% Section~\ref{sec:epi-mono-fact} presents the usual epi-mono
% factorization system in the light of homotopy type theory.
% %
% Section~\ref{sec:colim-homot-type} introduces the notion of colimits
% in homotopy type theory. 
% %
% And Section~\ref{sec:giraud-ax} defines an analogue of
% Giraud-Rezk-Lurie axioms on higher topoï that we need in the
% definition of sheafification.
% %
Some of the definitions and theorems of Section~\ref{ssec:hott} appear
in ~\cite{hottbook} (or are direct applications of results which do)
while others are specific to our formalization.

As a prerequisite, we encourage the reader to be familiar with type theory and
in particular the point of view developed
in~\cite{hottbook}. Nevertheless, we recall most of the central definitions 
that we use so that the paper is sufficiently self-contained.
%
Given a type $T$ and a type family $U : T \to \Type$, we denote
$\prod_{x:T} U x$ for the dependent product, $\sum_{x:T} U x$ for the dependent
sum, and $\pi_1, \pi_2$ for the first and second projection of a
dependent pair (denoted $(a;b)$). The identity path will be denoted
$1$. We use informal mathematical language
instead of type theory whenever it is possible, to ease in reading
without making our statements imprecise. In particular, (higher)
inductive types are defined using itemization to avoid an overhead of
notation. Throughout the paper, $\Type$ must be seen in an
universe-polymorphic way.

Section~\ref{ssec:hott} will present homotopy levels and object
classifiers, section~\ref{ssec:colim-homot-type} introduces a theory
of colimits in homotopy type theory, illustrated by an important
example in section~\ref{ssec:giraud-ax}.

 
 \subsection{Homotopy Types and Classifying Objects}
\label{ssec:hott}

One of the most direct applications of homotopical notions to type
theory is the introduction of homotopy types. 
%
Using the analogy that points in a space correspond to elements of a
type and that paths between two points correspond to 
elements of the corresponding identity type (which defines equality in type theory),  
%
an $n$-type is simply a type
for which equality becomes trivial above level $n$. 
%
Voevodsky has realized that this notion admits a compact inductive definition
internal to type theory, given by
% Our work is mainly based on the stratification by $\Type_n$:
\begin{defi}
  $\IsType n$ is defined by induction on $n\geqslant -2$:
  \begin{itemize}
  \item $\IsType {(-2)} X$ if $X$ is a contractible type, \ie{} $X$
    is pointed by $c:X$, and every other point in $X$ is equal to $c$.
  \item $\IsType {(n+1)} X \defeq \prod_{x,y:X} \IsType n (x=y).$
  \end{itemize}
  Then, $\Type_n \defeq \sum_{X:\Type} \IsType n X$.
\end{defi}
% For a type $X$, to be in $\Type_n$ means that paths spaces of $X$ are
% trivial after $n+1$ iteration.
%
When $n=-1$, we will use $\IsHProp$ and $\HProp$ instead of
$\IsType{(-1)}$ and $\Type_{-1}$. 
% \kq{rm}
% We also define some syntactic sugar for contractible types and mere propositions.

% \begin{itemize}
% \item $\IsContr \defeq \IsType {(-2)}$ and $\Contr \defeq \Type_{-2}$
% \item $\IsHProp \defeq \IsType {(-1)}$ and $\HProp \defeq \Type_{-1}$
% \end{itemize}

From any type $T$, the type
$\|T\|_n:\Type_n$ can be constructed as the HIT generated by
\begin{itemize}
\item a function $|\cdot|_n : T \to \|A\|_n$,
\item a proof of $\IsType n \|T\|_n$,
\end{itemize}
 satisfying the following universal property:
% Finally, we need to use mere propositions as basic elements of a logic
% when characterizing properties of types or functions. 
% %
% But as some constructors do not preserve the level of homotopy type
% (\eg sums or $\Sigma$-types), so we need to introduce $\squash{X}$, the
% {\em (propositional) truncation} of $X$ (also called bracket type, or
% squash type). This operation on types allows to truncate a type down
% to a mere proposition. Then for instance, the existential
% quantification on mere propositions ``there exists x:A such that
% P(x)'' can be defined as $ \squash{\sum_{x:A} P(x)}.  $

% Although proposition truncation could be seen as a primitive type former
% in homotopy type theory, it can also be defined using higher inductive
% types~\cite{lumsdaine2011higher,lumsdaine2013higher}. We adopt this
% point of view as it allows one to maintain the slogan that homotopy type
% theory is type theory plus univalence and higher inductive types.
% %

% Given any type $A$, its propositional truncation 
% $\squash{A} : \HProp$ is generated by 
% \begin{itemize}
% \item a function $|\cdot|_A : A \to \squash{A}$,
% \item for any $x,y:\squash{A}$, a path $x=y$.
% \end{itemize}
% % 
% The recursion principle of $\squash{A}$  asserts that any mere
% proposition that follows from $A$ already follows from $\squash{A}$.
\begin{lem}
  For any $A:\Type$ and $B:\Type_n$, if $f:A \to B$ then there is an
  induced $g:\|A\|_n\to B$ such that $g(|a|_n)= f(a)$ for any $a:A$.
\end{lem}
%
We refer the reader to~\cite[7.3]{hottbook} for more details on 
truncations.

% Using $\Type_n$ instead of just $\Type$ is the first step to connect
% type theory to higher topos theory. The next step is to exhibit a
% hierarchy of subobject classifiers on $n$-truncated homotopy fibers.
%
The homotopy fiber of a function $f$ at element $b$ is
defined as 
$
\fib{f}{b} \defeq \sum_{a:A} f(a) = b.
$
%
A function $f$ has $n$-truncated homotopy fibers (or simply
is an $n$-truncated function) when $\fib{f}{b}$
is in $\Type_n$ for any $b$.  
%
Again, we define some syntactic sugar. A function $f$ is 
\begin{itemize}
\item an {\em embedding} if $f$ is $(-1)$-truncated
\item a {\em surjection} if every fiber of $f$ is merely inhabited
  (i.e $\|\fib f y\|$ holds for all $y$).
\end{itemize}
One can show~\cite[Lemma 7.6.4]{hottbook} that any map $f$
factors uniquely through $\im(f) \defeq \sum_{y:B} \|\fib f y\|$ as a
surjection followed by an embedding.

Following~\cite{sets_in_hott}, it is possible to show that, for any
homotopy level $n$ and any type $B$, $\Type_n$ classifies subobjects
of $B$ with $n$-truncated homotopy fibers in the sense that there is
an equivalence
%
\[
  \chi : \sum_{A:\Type} \sum_{f:A \to B} \prod_{b\in B}
\IsType n\
\fib{f}{b} \xrightarrow{\sim} 
 (B \to \Type_n)
\]
%
 such that the usual subobject
 classifier diagram (\cite[Theorem 4.8.4]{hottbook}) is a pullback.
Therefore, in our construction, we will represent a subobject of a
type $B$ with $n$-truncated homotopy fibers either as a map $f:A\to B$
such that $\IsType n \fib{f}{b}$, or as a map $B\to \Type_n$.
% \begin{mymath}
% \xymatrix{
%   A \ar[r]^{\hspace{-1em} t_f} \ar[d]_f & \Type_n^\bullet \ar[d]^{\pi_1}\\
%   B \ar[r]_{\hspace{-1em} \chi_f} & \Type_n
% }
% \end{mymath}
% is a pullback for any $f$ with
 % $n$-truncated homotopy fibers where $\Type_n^\bullet \defeq
 % \sum_{A:\Type_n} A$ is the universe of pointed
% $n$-truncated types and 
% \begin{mymath}t_f = \lambda
  % a,~(\fib{f}{f(a)},(a,\mathrm{idpath})).
% \end{mymath}


% \subsection{The (n-Connected,n-Truncated) Factorization System}
% \label{sec:epi-mono-fact}

% \kq{Maybe delete this subsection?}
% We now recall the presence of a factorization system in homotopy type
% theory, constituted by embeddings and surjections.

% A map $f:A\to B$ is an \emph{embedding} when it is $(-1)$-truncated
% (see definition in Section~\ref{ssec:hott}), and a \emph{surjection}
% when it is $(-1)$-connected, that is when every fiber of $f$ is merely
% inhabited (\ie $\|\fib f y\|$ holds for all $y$).

% \begin{defi}
%   Let $f:A\to B$ be a function. The {\em image} of $f$ is defined as 
%   \begin{mymath}\im(f) \defeq \sum_{y:B} \|\fib f y\|.\end{mymath}
% \end{defi}
% The canonical function $\hat f : A \to \im(f)$ is (-1)-connected,
% being the left component of an orthogonal factorization system which
% satisfies~\cite[Lemma 7.6.4]{hottbook}:
% \begin{prop}
%   A map $f:A\to B$ factors uniquely (up-to homotopy) through
%   $\im(f)$ as a (-1)-connected function followed by a (-1)-truncated
%   function.
% \end{prop}

% Note that this generalizes to orthogonal factorization systems
% constituted by $n$-truncated morphisms and $n$-connected morphisms, for
% every truncated level $n$. We will only use the factorization system
% at level  $-1$ in the definition of sheafification.

\subsection{Colimits in Homotopy Type Theory }
\label{ssec:colim-homot-type}

One desireable construction we would like to consider is the \v{C}ech
nerve (Section~\ref{ssec:giraud-ax}). In order to do so, this section
presents a definition of colimits in a type theoretic setting.
% In the definition of (a special case of) Giraud-Rezk-Lurie axiom given in
% Section~\ref{sec:giraud-ax}, the colimit of the {\em \v{C}ech nerve}
% plays a central role.
% 
Following the definition of graphs and diagrams defined
in~\cite{lumsdaine}, we recall the definition of colimits of
diagrams overs graphs presented in~\cite{sets_in_hott}. 
%
% The main difference between limits and colimits is that limits are
% simply given by $\Sigma$-types, and thus exist already in traditional
% type theory, whereas the situation is more complicated for colimits as
% it requires the use of higher inductive types.

% Following~\cite{lumsdaine}, we introduce the notion of graph and
% diagram over a graph.
% %
% \begin{defi}
%   A {\em graph} $G$ is the data of
%   \begin{itemize}
%   \item a type $G_0$ of vertices;
%   \item for any $i,j:G_0$, a type $G_1(i,j)$ of edges.
%   \end{itemize}

%   A {\em diagram} $D$ over a graph $G$ is the data of
%   \begin{itemize}
%   \item for any $i:G_0$, a type $D_0(i)$;
%   \item for any $i,j:G_0$ and all $\phi : G_1(i,j)$, a map $D_1(\phi)
%     : D_0(i) \to D_0(j)$
%   \end{itemize}
% \end{defi}

A colimit of a diagram $D$ over a graph $G$ is given by a type $P$
that defines a cocone on $D$, plus the universal property that for any
type $X$, the canonical map that transforms a function $f : P
\rightarrow X$ to a cocone of $D$ on $X$ is an isomorphism.
% 
\begin{defi}\label{def:colimit}
Let $G$ be a graph, and $D$ be a diagram on $G$. 
Let $P:\Type$ together with
\begin{itemize}
\item a map $q_i : D_0(i) \to P$ for any
vertex $i:G_0$, \ie{} $q : \prod_{i:G_0} D_0(i) \to P$
\item for any vertices $i,j:G_0$ and all edges $\phi:G_1(i,j)$, a path
  $p_{i,j}^\phi : q_j \circ D_1(\phi) = q_i$, \ie{}
  $p : \prod_{i,j:G_0} \prod_{\phi:G_1(i,j)} q_j \circ D_1(\phi) = q_i.$
\end{itemize}

Then $P$ is the {\em colimit} of $D$ if for any other $X:\Type$, 
\[
\IsEquiv\left(\lambda f:P \to X, \left( \lambda i,~f \circ q_i\, ;\, \lambda i\, j\,
  \phi,\, f (p_{i, j}^\phi)) \right)\right).
\]
\end{defi}
Using higher inductive types, every diagram $D$ on a graph $G$ admits a
colimit in homotopy type theory. 

In~\ref{sssec:type_to_sep}, we will need to know how colimits
behave with respect to truncations. An answer is given by the
following lemma. 

\begin{lem}
  Let $D$ be a diagram, $m$ a truncation index, and
  $P:\Type_{m}$ a colimit of $D$. 
  Then, if $\|D\|_m$ is the same diagram as $D$ where every type
  is $m$-truncated, $P$ is a $m$-colimit\footnote{$P$ is a $m$-colimit
    if $P$ satisfies the same property as in~\ref{def:colimit} when
    we replace $\Type$ by $\Type_m$} of $\|D\|_m$.
\end{lem}
The proof is quite straightforward: a cocone over $D$ into
$P$ can be changed equivalently into a cocone over $\|D\|_m$ into $\|P\|_m$, using the
elimination principle of truncations, and then
we can show that the following diagram commutes for any $X:\Type_m$
\[
  \xymatrix{
    \|P\|_m \to X \ar[r] \ar[d]^*[@]{\hbox to 0pt{\hss$\sim$\hss}} & \mathrm{cocone}(\|D\|_m,X) \\
    P \to X \ar[r]^\sim& \mathrm{cocone}(D,X) \ar[u]^*[@]{\hbox to 0pt{\hss$\sim$\hss}}
  }
\]

% Essentially, being a colimit means making the diagram commutes, and
% being universal for this property.

% This colimit $\colim D$ is given by
% %
% \begin{itemize}
% \item a function $q:\prod_{i:G_0} D_0(i) \to \colim D$
% \item for any $i,j:G_0$ and $\phi:G_1(i,j)$, a path
%   $q_j \circ D_1(\phi) = q_i$.
% \end{itemize}
% %
% Although we have proved in our formalization that $\colim D$ is
% actually a colimit over $D$, we do not detail the proof here as the
% existence of colimits is not used in the definition of the
% sheafification process. We only make use of the following special case
% of Giraud-Rezk-Lurie axioms.

\subsection{On Giraud-Rezk-Lurie axioms}
\label{ssec:giraud-ax}


The Giraud-Rezk-Lurie axioms are the $\infty$-version of Giraud's
axioms that characterize a topos. Namely, there are four axioms on a
$(\infty,1)$-category that have been shown to be equivalent to
$(\infty,1)$-topos axioms~\cite[Chapter 6]{lurie}.
%
A consequence which we would like to use here is the fact that a surjection
(\ie{} $(-1)$-connected function) is the colimit of its \v{C}ech
nerve.
%
In~\cite{boulier}, the authors propose an analogue of this property:
they give, for any map $f$, a diagram $C(f)$ whose colimit is $\im(f)$.

This property will be essential in the proof that the construction
$\separated$, defined in Section~\ref{sssec:type_to_sep}, gives rise to a modality.

\begin{defi}
  Let $f:X \to Y$ be a map. The coequalizer $T_f$ of the kernel pair of $f$ is the higher inductive type given
  by
  \begin{itemize}
  \item $t:~X \to T_f$
  \item $\alpha:~\forall a\,b:X,~f(a) = f(b) \to t(a) = t(b)$
  \item $\alpha_1:~\forall a:X,~\alpha(a, a, 1) = 1$
  \end{itemize}
  We view $T_f$ as the coequalizer of
  $\xymatrix{
    \sum_{a,b:X} f(a) = f(b) \dar[r]{4pt}^-{\pi_1}_-{\pi_2} & X
  }$
  preserving the identity.
  We call $\tilde f$ the map $T_f \to Y$ given by induction.
\end{defi}

Then, the considered diagram $C(f)$  is the mapping telescope of the iterations
of $T$.
\begin{defi}
  Let $f$ be a map from $X$ to $Y$. Then the {\em iterated kernel pair} of
  $f$ 
  is given by the diagram
  $\xymatrix{
    C(f) := X \ar[r]^-t & T_f \ar[r]^-t & T_{\tilde f} \ar[r] &\cdots
  }$
\end{defi}

Let's recall the main theorem:
\begin{thm}[\thethm\ (Colimit of $C(f)$~\cite{boulier})]\label{cech}
  For any morphism $f : X \to Y$, the colimit of $C(f)$ is $\im(f)$,
  the image of $f$.
\end{thm}

% \subsection{On Giraud-Rezk-Lurie axioms}
% \label{sec:giraud-ax}

% The Giraud-Rezk-Lurie axioms are the $\infty$-version of Giraud's
% axioms that characterize a topos. Namely, there are 4 axioms on a
% $(\infty,1)$-category that have been shown to be equivalent to
% $(\infty,1)$-topos~\cite[Chapter 6]{lurie}. In~\cite{boulier}, a
% type-theoritic version of these axioms are proposed.
% %
% This particular case connects a surjection (or a $(-1)$-connected
% function) to the colimit of its \v{C}ech nerve.
% %
% This is the $\infty$-generalization of the fact that, in a topos,
% every epimorphism is the colimit of its kernel pair, which plays a
% central part in the definition of sheafification.

% \begin{defi}
%   Let $f:X \to Y$ be a map. $T_f$ is the higher inductive type given
%   by
%   \begin{itemize}
%   \item $t:~X \to T_f$
%   \item $\alpha:~\forall a\,b:X,~f a = f b \to t a = t b$
%   \item $\alpha_1:~\forall a:X,~\alpha\, a\, a\, 1 = 1$
%   \end{itemize}
%   We view $T_f$ as the coequalizer of
%   \begin{mymath}\xymatrix{
%     \sum_{a,b:X} f a = f b \dar[r]{4pt}^-{\pi_1}_-{\pi_2} & X
%   }\end{mymath}
%   preserving the identity.

%   We call $\tilde f$ the map $T_f \to Y$ given by induction.
% \end{defi}
% %
% The \v{C}ech nerve of a map $f$ can then be described as the
% simplicial object that, at degree $p$, is given by the
% $p$th iteration of $T$. 
% %
% \begin{defi}
%   Let $f$ be a map from $X$ to $Y$. The {\em \v{C}ech nerve} $C(f)$ of $f$
%   is given by the diagram
%   \begin{mymath}\xymatrix{
%     C(f) := X \ar[r]^t & T_f \ar[r]^t & T_{\tilde f} \ar[r] &\cdots
% % \cdots~ X \times_Y X \times_Y X \tar[r]{4pt} & X \times_Y X \dar[r]{2pt} & X
%   }\end{mymath}
% \end{defi}

% \begin{thm}[Giraud-Rezk-Lurie]
%   For any surjection $f : X \to Y$, the colimit of its \v{C}ech nerve
%   $C(f)$ is $Y$.
% \end{thm}

% With the point of view that homotopy type theory is a type-theoretic
% version of higher topos theory, this seems to be the analogous of Theorem 6.1.0.6 of~\cite{lurie}.
% %
% The proof of this theorem can be found in~\cite{boulier}.



\section{Modalities}
\label{sec:modalities}

This section presents modalities in Homotopy Type Theory as defined in
\cite{hottbook} and later developed in
\cite{EPTCS158.8,shulman2015Brouwer}. We have added proofs of various
properties of modalities when they are not already present in the
literature.
 %
A truncated version of modalities, specific to our work, is then
presented together with a discussion of the formalization.  

\begin{defi}
  \label{def:modality}
  A left exact modality is the data of
  \begin{enumerate}
  \item A predicate $P:\Type \to \HProp$
  \item For every type $A$, a type
    $\modal A$ such that $P(\modal A)$
  \item For every type $A$, a map $\eta_A:A \to
    \modal A$
  \end{enumerate}
  such that
  \begin{enumerate}
    \setcounter{enumi}{3}
  \item For every types $A$ and $B$, if $P(B)$ then
    \[ \left\{
        \begin{array}{rcl}
          (\modal A \to B) & \to & (A \to B) \\
          f & \mapsto & f \circ \eta_A
        \end{array} \right. \] %
    is an equivalence.
  \item for any $A:\Type$ and $B:A \to \Type$ such that $P(A)$
    and $\prod_{x:A} P(B x)$, then $P\left( \sum_{x:A} B(x)\right)$
  \item for any $A:\Type$ and $x,y:A$, if $\modal A$ is
    contractible, then $\modal (x=y)$ is contractible.
  \end{enumerate}
  Conditions (1) to (4) define a {\em reflective subuniverse}, (1) to
  (5) a {\em modality}.
\end{defi}

\begin{rmq}
  The inverse of $- \circ \eta_A$ from point {(4)} will be
  denoted $\modal_{\mathrm{rec}}: (A\to B) \to (\modal A \to B)$, and its
  computation rule $\modal_{\mathrm{rec}}^\beta : \prodD f {A \to B} {\prodD x A
  {\modal_{\mathrm{rec}}(f) (\eta_A x) = f x}}$.
\end{rmq}

If $\modal$ is a modality, the type of modal types will be denoted
$\Type^\modal$. Let us fix a left-exact modality $\modal$ for the rest
of this section. A modality acts functorialy on $\Type$, in the sense
that

\begin{lem}[\thelem\ (Functoriality of modalities)]
  Let $A,B:\Type$ and $f:A\to B$. Then there is a map $\modal f:\modal
  A \to \modal B$. Moreover
  \begin{itemize}
  \item For all $A,B:\Type$ and $f:A\to B$, $\modal f \circ \eta_A = \eta_B \circ f$.
  \item For all $X:Type$, $Y,Z:\Type^\modal$, $f:X\to Y$ and $g:Y\to
    Z$, 
    \[g \circ \modal_{\text{rec}}(f) = \modal_{\text{rec}} (g\circ
    f).\]
  \item For all $X,Y:Type$, $Z:\Type^\modal$, $f:X\to Y$ and $g:Y\to
    Z$, \[\modal_{\text{rec}}(g) \circ \modal f = \modal_{\text{rec}}
    (g\circ f).\]
  \item For all $X,Y,Z:\Type$, $f:X\to Y$ and $g:Y\to Z$, 
    \[\modal (g \circ f) = \modal g \circ \modal f.\]
  \item If $\IsEquiv f$, then $\IsEquiv \modal f$.
  \end{itemize}
\end{lem}
\begin{proof}
  We define $\modal f$ by
  \[ \modal f \defeq \modal_{\text{rec}}(\eta_B \circ f).\]
  Then
  \begin{itemize}
  \item By the computation principle of $\modal_{\text{rec}}$, the
    first point is obvious.
  \item As $Z$ is modal and both functions are $\modal X\to Z$, it suffices to show that 
    \[g \circ \modal_{\text{rec}} g \circ \eta_X = \modal_{\text{rec}} (g\circ
    f) \circ \eta_X.\]
    But both sides are equal to $g\circ f$ using computational rules.
  \item We will show that each side is equal to
    \[\varphi \defeq \modal_{\text{rec}} ((\modal_{\text{rec}} g) \circ (\eta_Y
    \circ f)).\]
    The left-hand side is equal to $\varphi$ using the previous point,
    applied to $\eta_Y \circ f$.
    For the right-hand side, it suffices to show that
    $g\circ f = \modal_{\text{rec}}(g) \circ \eta_Y \circ f,$
    which is exactly the computation rule of $\modal_{\text{rec}}$
    composed with $f$.
  \item This is a particular case of the previous point, applied to
    $f$ and $\eta_Z \circ g$.
  \item If $f$ is an equivalence, an obvious inverse for $\modal f$ is
    $\modal (f^{-1})$.

  \end{itemize}
\end{proof}
\begin{prop}\label{prop:mod_prop}
  Any left-exact modality $\modal$ satisfies the following
  properties\footnote{Properties needing only a reflective subuniverse
    are annotated by (R), a modality by (M), a left-exact modality by (L)}.
  \begin{itemize}
  \item[\labelitemi(R)] $A$ is modal if and only if $\eta_A$ is an equivalence.
  \item[\labelitemi(R)] $\one$ is modal.
  \item[\labelitemi(R)] $\Type^\modal$ is closed under dependent
    products, \ie{} $\prodD x A {B\, x}$ is modal as soon as all $B\,
    x$ are modal.
  \item[\labelitemi(R)] For any types $A$ and $B$, the map
    \[ \modal(A\times B) \to \modal A \times\modal B \]
    is an equivalence.
  \item[\labelitemi(R)] If $A$ is modal, then for all $x,y:A$, $(x=y)$
    is modal.
  \item[\labelitemi(M)] For every type $A$ and $B:\modal(A)\to\Type^\modal$, then
    \[ \fonction{-\circ\eta_A}{\prodD z {\modal A} {B\, z}}{\prodD a
        A {B(\eta_A\, a)}}{f}{f\circ \eta_A} \]
    is an equivalence.
  \item[\labelitemi(M)] If $A,B:\Type$ are modal, then so are $\IsType
    n A$, $A\simeq B$ and $\IsEquiv f$ for all $f:A\to B$.
  \item[\labelitemi(L)] If $X,Y:\Type$ and $f:X\to Y$, then the map
    \[ \modal \left( \fib f y\right) \to \fib{\modal f}{\eta_B
        y} \]
    is an equivalence, and the following diagram commutes
\[ \xymatrix{
  \fib f y \ar[r]^\eta \ar[d]_\gamma & \modal \left(\fib f y \right) \ar[dl]\\
  \fib{\modal f}{\eta_B y} & }\] 
  \end{itemize}
\end{prop}

\begin{rmq}
  Again, the inverse of $- \circ \eta_A$ will be denoted
  $\modal_{\mathrm{ind}} : \prodD a A {B (\eta_A a)} \to \prodD z
  {\modal A} {B\, x}$, and its computation rule
  $\modal_{\mathrm{ind}}^\beta : \prodD f {\prodD a
        A {B(\eta_A\, a)}} {\prodD x A
        {\modal_{\mathrm{ind}}(f)(\eta_A x) }} = f x$
\end{rmq}

\begin{proof}
  % Some points are already proved in~\cite{hottbook}.
  \begin{itemize}
  \item If $\eta_A$ is an equivalence, then $A\simeq \modal A$, so $A$
    is modal. 

    Now if $A$ is modal, then we have $\modal_{\text{rec}}(\id) :
    \modal A \to A$, and one can easily check that it is an inverse to $\eta_A$.
  \item Given the previous proof, it suffices to prove that
    $\eta_\one$ is an equivalence. The only way to inhabit
    $\modal\one \to \one$ is with $\lambda\, x, \unittt$. It is
    straightforward to check that this forms an equivalence.
  \item This is~\cite[Theorem 7.7.2]{hottbook}.
  \item This is~\cite[Corollary 7.7.3]{hottbook}.
  \item Again, it suffice to show that $\eta_{x=y}$ is an
    equivalence. We begin by showing that 
    \[ (\lambda\, \_ : \modal(x=y),\, x) = (\lambda\, \_ :
    \modal(x=y),\, y).\]
    As $A$ is modal, $\eta_A$ is an equivalence, as well as
    $\ap{\eta_A} : x=y \to \modal(x=y)$. Thus, it suffices to show that
     \[ (\lambda\, \_ : \modal(x=y),\, x) \circ \ap{\eta_A}) = (\lambda\, \_ :
    \modal(x=y),\, y) \circ\ap{\eta_A},\]
    and the latter is obvious using functional extensionality. 
    Now, applying the just proved equality to any $u:\modal(x=y)$
    yields $x=y$. One can prove that this defines an inverse to $\eta_{x=y}$.
  \item This is~\cite[Theorem 7.7.7]{hottbook}.
  \item We show that $\IsType n A$ is modal by induction on the truncation level $n$. 
    
    If $n=-2$, we have $\IsType n A \simeq \sumD a A {\prodD b A {b =
        a}}$. The latter is modal using stability by dependent sums,
    dependent products and paths type.

    Now, if for every $A$, $\IsType n A$ is modal, then $\IsType
    {(n+1)} A$ is equivalent to \[\prodD {x,y} A {\IsType n {x=y}}.\]
    Again, using stability by dependent products and the induction
    hypothesis, the latter is modal.

    The facts that $A\simeq B$ and $\IsEquiv f$ for any modal types
    $A,B$ and map $f:A\to B$ are modal are technical, but don't
    involve new methods. They can be found
    in the formalization.
  \item 
    It is straightforward to define a map
    \[ \phi:\sumD x X  {f x = y}\to
    \sumD x {\modal X} {\modal f x = \eta_Y y},\]
    using $\eta$ functions.
    We will use the following lemma to prove that the function induced
    by $\phi$ defines an equivalence:
    \begin{lem}
      Let $X:\Type$, $Y:\Type^\modal$ and $f:X\to Y$. If for all $y:Y$,
      $\modal (\fib f y)$ is contractible, then the function $\modal X
      \to Y$ induced by $f$ is an equivalence.
    \end{lem}
    % 
    Hence we just need to check that every $\modal$-fiber $\modal(\fib \phi {x;p})$ is contractible.
    Technical transformations allow one to prove
    \[ \fib\phi{x;p} \simeq \fib s {y;p^{-1}}\]
    for
    \[
    \fonction{s}{\fib{\eta_X}x}{\fib{\eta_Y}{\modal f\, x}}{(a,q)}{(f\, a,-)}
    \]
    But left-exactness allows to characterize the contractibility of fibers:
    \begin{lem}
      Let $A,B:\Type$. Let $f:A\to B$. If $\modal A$ and $\modal B$ are
      contractible, then so is $\modal(\fib f b)$ for any $b:B$.
    \end{lem}
    Thus, we just need to prove that $\modal(\fib {\eta_X} a)$ and
    $\modal(\fib {\eta_Y} b)$ are contractible. But one can check that
    $\eta$ maps always satisfy this property.
    Finally, $\modal(\fib s{y;p^{-1}})$ is contractible, so $\modal(\fib
    \phi {x;p})$ also, and the result is proved.
  \end{itemize}
  % \kq{Finish that}

  % \nt{Indeed, I can't follow the proof for the moment}
\end{proof}

Let us finish these properties by the following proposition, giving
an equivalent characterization of left-exactness.

\begin{prop}\label{prop:lex}
  Let $\modal$ be a modality. Then $\modal$ is left-exact if and only
  if
  $\modal$ preserves path spaces, \ie{}
    \[
      \prodD A \Type {\prodD {x,y} A {\IsEquiv (\modal (\ap{\eta_A}))}}
    \]
    where $\modal (\ap{\eta_A}) : \modal(x = y) \to \eta_A x = \eta_A
    y$.
  % \end{itemize}
\end{prop}
\begin{proof}
  We will rather prove something slightly more general, using an
  encode-decode proof~\cite[Section 8.9]{hottbook}; we will
  characterize, for a type $A$ and a fixed inhabitant $x:A$ the type 
  \[ \eta_A x = y \] 
  for any $y:\modal A$.
  
  \newcommand{\Cover}{\mathrm{Cover}}
  \newcommand{\Encode}{\mathrm{Encode}}
  \newcommand{\Decode}{\mathrm{Decode}}
  Let $\Cover:\modal A \to \Type^\modal$ be defined by induction by
  \[ \Cover(y) \defeq \modal_{\mathrm{rec}} (\lambda y,\,\modal (x =
    y)). \]
  Note that for any $y:\modal A$, $\Cover(y)$ is always modal.
  We will show that $\eta_A x = y \simeq Cover(y)$.
  Now, let $\Encode : \prodD y {\modal A} {\eta_A x = y \to
    \Cover(y)}$ be defined by
  \[ \Encode(y,p) \defeq \transport_{\Cover}^p
    \left(\transport_{\idmap}^{\modal_{\mathrm{rec}}^\beta ((\lambda
        z,\,\modal (x = z)), x)} (\eta_{x=x} 1)\right) \]
  and $\Decode:\prodD y {\modal A} {\Cover(y) \to \eta_A x = y}$ by
  \[
    \Decode \defeq \modal_{\mathrm{ind}} \left(\lambda y\,p,\,
    \modal(\ap{\eta_A})  \left(\transport_{\idmap}^{\modal_{\mathrm{rec}}^\beta ((\lambda
        z,\,\modal (x = y)),y)} p\right)\right)
  \]
  Then one can show, using $\modal$-induction and path-induction, that
  for any $y:\modal A$, $\Encode(y,-)$ and $\Decode(y,-)$
  are each other inverses. Then, taking $y' = \eta_A y$, we have just
  shown that $\eta_A x = \eta_A y \simeq Cover(\eta_A y)$, which is
  itself equivalent, by $\modal_{\mathrm{rec}}^\beta$, to $\modal
  (x=y)$.
  It is straightforward to check that the composition $\modal (x=y)
  \to \Cover(\eta_A y) \to \eta_A x = \eta_A y$ is exactly $\modal
  (\ap{\eta_A})$.
  
  Now, let us prove the backward implication. Let $A$ be a type such
  that $\modal A$ is contractible, and $x,y:A$. 
  As $\eta_A x,\eta_A y: \modal A$, we know that $\eta_A x = \eta_A y$
  is contractible. But as $\eta_A x = \eta_A y \simeq \modal (x=y)$ by
  assumption, $\modal (x=y)$ is also contractible.
\end{proof}

As this whole paper deals with truncation levels, it should be
interesting to see how they are changed under a modality. 
We already know that if a type $T$ is $(-2)$-truncated, \ie{}
contractible, then it is unchanged by the reflector: \[\modal T \simeq
\modal \one \simeq \one \simeq T.\] Thus, $\Type_{-2}$ is closed by
any reflective subuniverse.
%
Now, let $T:\HProp$. To check that $\modal T$ is an h-proposition, it
suffices to check that \[\prodD {x,y} {\modal T} {x = y}\] 
For any $x:\modal T$, the type $\prodD y {\modal T} {x = y}$
is modal, as all $x=y$ are; by the same argument, $\prodD x {\modal T} {x =
  y}$ is modal too for any $y:\modal T$. 
Using twice the dependent eliminator of $\modal$, it now suffices to
check that \[\prodD {x,y} T {\eta_T x = \eta_T y}.\]
As $T$ is supposed to be an h-proposition, this is true. It suffices
to state
\begin{lem}\label{lem:mod-hprop}
  For any modality, $\Type_{-1}$ is closed under the reflector
  $\modal$, \ie{} \[\prodD P \HProp {\IsHProp (\modal P)}.\]
\end{lem}

A simple induction on the truncation level, together with the
left-exactness property allows to state
\begin{lem}\label{lem:mod-istrunc}
  For any left-exact modality, all $\Type_p$ are closed under the
  reflector $\modal$, \ie{}
  \[\prodD P {\Type_p} {\IsType p (\modal P)}.\]
\end{lem}




\subsection{Examples of modalities}
\label{ssec:modalities-examples}

\subsubsection{The identity modality}
\label{sssec:id_mod}

Let us begin with the most simple modality one can imagine: the one
doing nothing. We can define it by letting $\modal A \defeq A$ for any type
$A$, and $\eta_A \defeq \idmap$. Obviously, the desired computation
rules are satisfied, so that the identity modality is indeed a
left-exact modality.

It might sound useless to consider such a modality, but it can be
precious when looking for properties of modalities: if it does not
hold for the identity modality, it cannot hold for an abstract one.


\subsubsection{Truncations}
\label{sssec:truncations}

The first class of non-trivial examples might be the {\em truncations}
modalities, as described in~\cite[Section 7.3]{hottbook}.

\subsubsection{Double negation modality}
\label{sssec:notnot}

\begin{prop}
  The double negation modality $\modal A \defeq \lnot\lnot A$ is a
  modality.  
\end{prop}
\begin{proof}
  We define the modality with
  \begin{enumerate}
  \item We will define the predicate $P$ later.
  \item $\modal$ is defined by $\modal A = \lnot\lnot A$
  \item We want a term $\eta_A$ of type $A \to \lnot \lnot A$.
    The term
    \[ \eta_A\defeq \lambda \, x:A,\,\lambda\, y:\lnot A,\, y\, a\] 
    matches this requirement.
    
    Now, we can define $P$ to be exactly $\prodD A \Type {\IsEquiv
      \eta_A}$.
  \item Let $A,B:\Type$, and $\varphi : A \to \lnot\lnot B$. We
    want to extend it into $\psi : \lnot\lnot A \to \lnot\lnot B$. Let
    $a:\lnot\lnot A$ and $b:\lnot B$.
    Then $a(\lambda\, x:A,\, \varphi\, x \, b) : \zero$, as
    wanted. One can check that it forms an equivalence.
  \item Let $A:\Type$ and $B:A\to\Type$ such that $P(A)$ and $\prodD a
    A {P(B\, a)}$. There is a map
    \[\sumD x A {B\, x} \to A \]
    thus by the previous point, we can extend it into 
    \[\kappa:\lnot\lnot\sumD x A {B\, x} \to A.\]
    It remains to check that for any $x:\lnot\lnot\sumD x A {B\, x}$,
    $B(\kappa\, x)$.

    But the previous map can be easily extended to the dependent case,
    and thus it suffices to show that for all $x:\sumD x A{B\, x}$,
    $B(\kappa(\eta\, x)$. As $\kappa \circ \eta = \idmap$, the goal is
    solved by $\pi_2 x$.
  \end{enumerate}
\end{proof}

Unfortunately, it follows that the only types which can be modal are
h-propositions, as they are equivalent to their double negation which
is always an h-proposition. Thus, the type of modal types consists
only of h-propositions, which is not satisfactory. The main purpose of this
paper is to extend this
modality into less destructive one.

\subsection{Toward a new type theory}
\label{ssec:new-type-theories}


We suppose here that $\modal$ is a left-exact modality such that
$\Type^\modal$ is modal.
This is for example the case when the modality is {\em accessible}
(see~\cite{hottlib} for definition and proof).
We call a modality $\modal$ {\em consistent} if $\modal\zero$
is empty.
\begin{prop}
  The modal universe $\Type^\modal$ is non-trivial (non contractible) if the type $\modal
  \zero$ is empty.
\end{prop}
\begin{proof}
  By condition (iv) of Definition~\ref{def:modality},
  $\modal \zero$ is an initial object of $\Type^\modal$, and thus
  corresponds to false for modal mere proposition.
  % 
  As $\modal \one = \one$, $\Type^\modal$ is non-trivial when
  $\modal \zero \neq \one$, that is when there is no proof of
  $\modal \zero$.
\end{proof}

In topos theory, Lawvere-Tierney topologies give rise to subtoposes
$\Sh{j}\mathcal E \hookrightarrow \mathcal E$; actually, every
subtopos $\mathcal F \hookrightarrow \mathcal E$ comes from a
Lawvere-Tierney topology~\cite[Corollary VII.4.7]{maclanemoerdijk}.
In the same way, left-exact modalities should induce sub-type
theories, and we should be able to exhibit a translation from this
sub-type theory into the ground type theory, as in~\cite{forcing2016}.

% \begin{prop}\label{prop:consistent}
%   A left exact modality $\modal$ induces a consistent type theory if
%   and only if $\modal \zero$ can not be inhabited in the initial type
%   theory. In that case, the modality is said to be consistent.
% \end{prop}
% \begin{proof}
%   By condition (iv) of Definition~\ref{def:modality},
%   $\modal \zero$ is an initial object of $\Type^\modal$, and thus
%   corresponds to false for modal mere proposition.
%   % 
%   As $\modal \one = \one$, $\Type^\modal$ is consistent when
%   $\modal \zero \neq \one$, that is when there is no proof of
%   $\modal \zero$.
% \end{proof}

\subsection{Truncated modalities}
\label{ssec:trunc_modalities}

As for colimits, we define a truncated version of modalities, in order
to use it in section~\ref{sec:sheaf_hott}. Basically, a truncated modality
is the same as a modality, but restricted to $\Type_n$. 

\begin{defi}[\thethm\ (Truncated modality)]
  \label{def:tr_mod}
  Let $n\geq -1$ be a truncation index. A left exact modality at level
  $n$ is the data of
  \begin{enumerate}
  \item A predicate $P:\Type_n \to \HProp$
  \item For every $n$-truncated type $A$, a $n$-truncated type
    $\modal A$ such that $P(\modal A)$
  \item For every $n$-truncated type $A$, a map $\eta_A:A \to
    \modal A$
  \end{enumerate}
  such that
  \begin{enumerate}
    \setcounter{enumi}{3}
  \item For every $n$-truncated types $A$ and $B$, if $P(B)$ then
    \[\left\{
      \begin{array}{rcl}
        (\modal A \to B) & \to & (A \to B) \\
        f & \mapsto & f \circ \eta_A
      \end{array} \right.\]
    is an equivalence.
  \item for any $A:\Type_n$ and $B:A \to \Type_n$ such that $P(A)$
    and $\prod_{x:A} P(B x)$, then $P\left( \sum_{x:A} B(x)\right)$
  \item for any $A:\Type_n$ and $x,y:A$, if $\modal A$ is
    contractible, then $\modal (x=y)$ is contractible.
  \end{enumerate}
\end{defi}

Properties of truncated left-exact modalities described
in~\ref{prop:mod_prop} are still true when restricted to $n$-truncated
types, except the one that does not make sense: $\Type_n^\modal$
cannot be modal, as it is not even a $n$-truncated type.

\subsection{Formalization}
\label{ssec:mod-formalization}

Let us discuss here the formalization of the theory of
modalities. General modalities are formalized in the Coq/HoTT
library~\cite{hottlib}, thanks to the work of Mike
Shulman~\cite{modules-modalities}. The formalization might seem
straightforward, but the universe levels (at least, their automatic
handling by Coq) become a major issue. Hence, we have to explicitly
give the universe levels and their constraints in a large part of the
library. For example, the reflector $\modal$ of a modality is defined
in~\cite{hottlib} as
\[ \modal : \Type^i \to \Type^i ;\]
it maps any universe to itself.

In section~\ref{sec:sheaf_hott}, we will need a slightly more general
definition of modality. The actual definitions stay the same, but the
universes constraints we consider change. The reflector $\modal$ will
now have type
\[ \modal : \Type^i \to \Type^k,\quad i \leqslant k ;\]
it maps any universe to a possibly higher one.
Other components of the modality will have types
\[\begin{array}{llll}
  P &:& \Type^i \to \HProp^k, & i\leqslant k \\
  \eta &:& \prodD A {\Type^i} {\modal A : \Type^{k}}, & i \leqslant k\\
  - &:& \prodD A {\Type^i} {
          \prodD B {\Type^j} {
          \prodD h {P(B)} {
          \IsEquiv ( - \circ \eta_A)
          }}}, & i,j \leqslant k
\end{array}\]

Fortunately, this change is small enough as to preserve usual properties of
modalities. Of course, the examples of modalities mapping
any universe to itself are still examples of generalized modalities,
simply ones which do not make use of the possibility of inhabiting a higher
universe. 

We would like to have the same generalization for truncated
modalities. However, in this case many new universe levels appear,
mostly because in $\Type_n = \sumD T \Type {\IsType n T}$, and $\IsType n$
each comes with its own universe. As a result, handling ``by hand'' so many
universes together with their constraints quickly gets out of
control. One idea to fix this issue could be to use {\em resizing
  rules}~\cite{vv-resizing}, allowing h-propositions to live in the
smallest universe. We could then get rid of the universes generated by
$\IsType n$, and treat the truncated modality exactly as any other generalized
modality.

In our formalization, we decided to work with the \code{type-in-type}
Coq option, to avoid any issue with universes.


\section{Sheaves in toposes}
\label{sec:sheaf_topos}

In this section, we will work in an arbitrary topos rather than in
type theory. The next section will present a generalization of the
results presented here.

Let us fix for the whole section a topos $\mathcal E$, with subobject
classifier $\Omega$. A {\em Lawvere-Tierney topology} on $\mathcal E$
is a way to modify slightly truth values of $\mathcal E$. It allows one to
speak about {\em locally true} things instead of {\em true} things.

\begin{defi}[\thethm\ (Lawvere-Tierney topology~\cite{maclanemoerdijk})]\label{defi:LT}
  A Lawvere-Tierney topology is an endomorphism $j:\Omega \to \Omega$
  preserving $\True$ ($j \ \True = \True$), idempotent ($j\circ j =
  j$) and commuting with products ($j \circ \wedge = \wedge \circ (j,j)$).
\end{defi}

A classical example of Lawvere-Tierney topology is given by double
negation. Other examples are given by Grothendieck topologies, in the
sense of the following:

\begin{thm}[\thethm\ ({\cite[Theorem V.1.2]{maclanemoerdijk}})]
  Every Grothendieck topology $J$ on a small category $\mathbf C$ determines a
  Lawvere-Tierney topology $j$ on the presheaf topos
  $\mathbf{Sets}^{\mathbf C^{\mathbf{op}}}$.
\end{thm}

Any Lawvere-Tierney topology $j$ on $\mathcal E$ induces a closure operator
$A \mapsto \closure{A}$ on subobjects. If we see a subobject $A$ of $E$
as a characteristic function $\Char{A}$, the closure $\closure{A}$
corresponds to the subobject of $E$ whose characteristic function is 
%
\[
\Char{\closure{A}} = j \circ \Char{A}.
\]%
%
A subobject $A$ of $E$ is said to
be dense when $\closure{A} = E$.

Next, we are interested in objects of $\mathcal E$ for which it is
impossible to make a distinction between objects and their dense
subobjects, \ie{} for which ``true'' and ``locally true''
coincide. Such objects are called {\em sheaves}, and are defined by

\begin{defi}[\thethm\ (Sheaves{\cite[Section V.2]{maclanemoerdijk}})]
  On object $F$ of $\mathcal E$ is a sheaf (or $j$-sheaf) if for every
  dense monomorphism $m: A \hookrightarrow E$ in $\mathcal E$, the
  canonical map $\Hom{\mathcal E}(E,F) \rightarrow \Hom{\mathcal E}(A,F)$ is an
isomorphism.
\end{defi}

One can show that $\Sh{\mathcal E}$, the full sub-category of
$\mathcal E$ given by
sheaves, is again a topos, with classifying object
%
\[
\Omega_j = \{ P \in \Omega \ | \ j P  = P \}.
\]

Lawvere-Tierney sheafification is a way to build a left adjoint $\mathbf{a}_j$ to the
inclusion $\mathcal E \hookrightarrow \Sh{\mathcal E}$, exhibiting
$\Sh{\mathcal E}$ as a reflective subcategory of $\mathcal E$. In
particular, this implies that logical principles valid in $\mathcal E$
are still valid in $\Sh{\mathcal E}$.

For any object $E$ of $\mathcal E$, $\mathbf{a}_j(E)$ is defined as in
the following diagram
\[
  \xymatrix{ 
    E \ar[rr]^{\{\cdot\}_E} \ar@{->>}[d]_{\theta_E} && \Omega^E \ar[d]^{j^E}\\
    E' \ar@{^{(}->}[rr] \ar[dr]_{\text{closure}} && \Omega_j^E \\
    & \mathbf{a}_j(E) \ar[ur]&
  }
\]

The proof that $\mathbf a_j$ defines a left adjoint to the inclusion
can be found in~\cite{maclanemoerdijk}.

One classical example of use of sheafification is the construction,
from any topos, of a boolean topos negating the continuum
hypothesis. More precisely:

\begin{thm}[\thethm\ (Negation of CH~{\cite[Theorem VI.2.1]{maclanemoerdijk}})]
  There exists a Boolean topos satisfying the axiom of choice, in
  which the continuum hypothesis fails.
\end{thm}

The proof actually follows almost exactly the famous construction by
Paul Cohen of a model of ZFC negating the continuum
hypothesis~\cite{cohen1966}. Together with the model of constructible
sets $\mathfrak L$ by Kurt Gödel~\cite{godel40}, this proves that CH is
independent of ZFC, solving Hilbert's first problem.

\section{Sheaves in homotopy type theory}
\label{sec:sheaf_hott}

The idea of this section is to consider sheafification in toposes as
only the first step towards sheafification in type theory.  We remark
that axioms for a Lawvere-Tierney topology on the subobject classifier
$\Omega$ of a topos are very close to those of a modality on
$\Omega$. We will use this idea extensively, applying it to every
subobject classifier $\Type_n$ as described in
section~\ref{sec:hott}. The subobject classifier $\Omega$ of a topos
is seen as the object of {\em truth values} of the topos, which
corresponds to the type $\HProp$ in our setting; the topos itself is
considered proof irrelevant, corresponding to our
$\HSet$. Sheafification in toposes, when translated to
the setting of homotopy type theory, is thus a way to build from a left-exact
modality on $\HProp$, a left-exact modality on $\HSet$. Our hope in
this section is to iterate this construction, extending a left-exact
modality on $\HSet$ to one on $\Type_1$, and so on.

The first thing we can note is that such a construction will not allow
to reach every type: it is known that there exist types with no finite
truncation level~\cite[Example 8.8.6]{hottbook}. Worse, some
types are not even the limit of their successive truncations, even in an
hypercomplete setting~\cite{morelvv}. This suggests that defining a
sheafification functor for all truncated types won't give (at least
easily) a sheafification functor on the whole of $\Type$.  Another
issue which must be pointed out is the complexity of proofs. Whereas
in a topos-theoretic setting everything is proof-irrelevant, this is
no longer the case in a higher setting, forcing us to reason about
witnesses for results which were previously true on the nose. This
will oblige us to write long and technical proofs of coherence, and
occasionally to completely modify some lemmas, such as
Proposition~\cite[Theorem IV.7.8]{maclanemoerdijk}, stating that
epimorphisms are coequalizers of their kernel pairs.

The main idea is thus to follow as closely as possible the
topos-theoretic construction, and change it as few times as possible to
make it work in our higher setting.

Note that, as the principles we want to add are inherited directly
from the $\HProp$ level, the extension to all truncated types is
automatic. The choice of the left-exact modality on $\HProp$ is thus
crucial. For the rest of the section, we fix one, denoted
$\modal_{-1}$. The reader can think of the double negation
$\modal_{\lnot\lnot}$ defined in~\ref{sssec:notnot}. We will define,
by induction on the truncation level, left-exact modalities on all
$\Type_n$, as in the following theorem.

\begin{thm}\label{thm:main}
  The sequence defined by induction by
  \[ \begin{array}{l}
   \modal : \forall \ (n : nat), \ \Type_n \to \Type_n 
   \\
    \modal_{-1\phantom{n}}(T) \quad\text{given} \\

      \displaystyle{\modal_{n+1}(T)} \defeq  
      \displaystyle{\sum_{u:T \to \Type_n^\modal} \!\!\!\!\modal_{-1} 
      \left\|
      \sum_{a:T} u= (\lambda t,~\modal_n (a=t))
      \right\|}
    \end{array}
\]
defines a sequence of left-exact modalities, coherent with each others
in the sense that the following diagram commutes for any $P:\Type_n$,
where $\hat P$ is $P$ seen as an inhabitant of $\Type_{n+1}$.
\[ \xymatrix{
    P \ar@{->}^{\sim}[r] \ar[d]_{\eta_{n}} & \widehat P \ar[d]^{\eta_{n+1}} \\
    \modal_{n} P \ar@{->}^{\sim}[r] & \modal_{n+1} \widehat P 
  } \]
\end{thm}
In what follows, formalized results are indicated by the name of the
result in the library in \code{\textsc{this special font}}.

\subsection{Sheaf theory}
\label{ssec:sheaves}

Let $n$ be a truncation index greater that $-1$, and $\modal_n$ be the
left-exact modality given by our induction hypothesis. As in the
topos-theoretic setting, we will define what it means for a type to be
a $n$-sheaf (or just ``sheaf'', if the context is clear), and consider
the reflective subuniverses of these sheaves; the reflector will
exactly be the sheafification functor.
The main issue in order to arrive at the ``right'' definition is the choice of the
subobject classifier in which dense subobjects will be chosen: two
choices appear, $\HProp$ and $\Type_n$; we will actually use
both. This principle guiding our choice is that the type of
all $n$-sheaves should be a $(n+1)$-sheaf.

From the modality $\modal_n$, one can build a {\em closure operator}.

\begin{defi}[\thethm\ (\code{cloture},\code{closed},\code{EnJ})]
  Let $E$ be a type. 
  \begin{itemize}

  \item The {\em closure} of a subobject of $E$ with
  n-truncated homotopy fibers (or $n$-subobject of $E$, for short),
  classified by $\chi : E \to \Type_n$, is the subobject of $E$
  classified by $\modal_n \circ \chi$.

  
\item An $n$-subobject of $E$ classified by $\chi$ is said to be {\em
    closed in $E$} if it is equal to its closure, \ie{} if
  $\chi = \modal_n \circ \chi$.

  
\item An $n$-subobject of $E$ classified by $\chi$ is said to be {\em
    dense in $E$} if its closure is $E$, \ie{} if 
  $\modal_n \circ \chi = \lambda e, \one$ 
  \end{itemize}
\end{defi}


Topos-theoretic sheaves are characterized by a property of existence
and uniqueness, which will be translated, as usual, into a proof that
a certain function is an equivalence.

\begin{defi}[\thethm\ (Restriction (\code{E\_to\_$\chi$mono\_map}, \code{E\_to\_$\chi$\_map}))]
  Let $E,F:\Type$ and $\chi:E\to\Type$. We define the {\em
    restriction map} $\Phi_E^\chi$ as
  \[
    \fonction{\Phi_E^\chi}{E\to F}{\sumD e E {\chi e} \to F}{f}{f\circ \pi_1}.
  \]
\end{defi}

Here, we need to distinguish between
dense $(-1)$-subobjects, which will be used in the definition of
sheaves, and dense $n$-subobjects, which will be used in the definition
of separated types. 

\begin{defi}[\thethm\ (Separated Type (\code{separated}))]
  A type $F$ in $\Type_{n+1}$ is {\em separated} if for any type $E$, and
  all dense $n$-subobject of $E$ classified by $\chi$,
  $\Phi_E^\chi$ is an embedding.
\end{defi}

From a point of view of topos theory, this means that given a map $\sum_{e:E}
\chi\, e \to F$,
if there is an extension $\tilde f:E\to F$, then it is unique, as in
 \[ \xymatrix{
    \sumD e E {\chi e} \ar[r]^-f \ar[d]_{\pi_1} & F \\
    E \ar@{-->}[ru]_{!}&
  }\]
\begin{defi}[\thethm\ (Sheaf (\code{Snsheaf\_struct}))]
  A type $F$ of $\Type_{n+1}$ is a {\em $(n+1)$-sheaf} if it is
  separated, and for any type $E$ and all dense $(-1)$-subobject of
  $E$ classified by $\chi$, $\Phi_E^\chi$ is an
  equivalence.
\end{defi}

In this case, this means that given a map $f : \sum_{e:E}
\chi\, e\to F$, one can
extend it uniquely to $\tilde f:E \to F$, as in 
 \[ \xymatrix{
    \sumD e E {\chi e} \ar[r]^-f \ar[d]_{\pi_1} & F \\
    E \ar@{-->}[ru]_{\exists !}&
  }\]

Note that these definitions are almost the same as those given in 
in~\cite{maclanemoerdijk}. The main difference is that {separated}
is defined for $n$-subobjects, while {sheaf} only for
$(-1)$-subobjects. It might seem bizarre to make such a distinction,
but the following proposition gives a better understanding of the situation.
\begin{prop}[\thethm\ (\code{nj\_paths\_separated})]
  A type $F$ is $\Type_{n+1}$ is separated if, and only if all its
  path types are $n$-modal.
\end{prop}

\begin{proof}
  Let $F:\Type_{n+1}$ a separated type, and $a,b:F$. We want to find
  an inverse to $\eta_{a=b}$. We consider the following diagram 
   \[ \xymatrix{
    \sumD {(a,b)} {F\times F} {a=b} \ar[r]^-{\text{fst} \circ \pi_1} \ar[d]_{\iota} & F \\
    \sumD {(a,b)} {F\times F} {\modal(a=b)}
    \dar[ru]{2pt}_{\quad\text{fst}\circ \pi_1} ^{\text{snd} \circ \pi_1} &
  }\]
  Both $\text{fst} \circ \pi_1$ and $\text{snd}\circ\pi_1$ make the
  diagram commute, hence they are equal:
  \[\prodD {a,b} f {\modal (a=b) \to a = b}.\]
  One can check that this defines an inverse to $\eta_{a=b}$.


  Conversely, let $E:\Type$, $\chi: E \to\Type_n$ and $f,g: E\to
  F$ such that $p:f\circ\pi_1 = g\circ \pi_1$.
  Using functional extensionality, we want to show that $f\, x=g\,x $
  for any $x:E$. As $\sumD e E {\chi\, e}$ is a dense $n$-subobject of $E$,
  $\modal_n (\chi\, x)$ is inhabited. By hypothesis, $f\, x = g\, x$
  is modal, thus by induction principle of $\modal$, we can suppose
  that we can inhabit $\chi\, x$ with a term $w$. We can then apply
  the equality $p$ to the dependent pair $(x;w)$ to have $f\, x =
  g\, x$, as required. 
\end{proof}

A $(n+1)$-sheaf is hence just a type satisfying the usual property of sheaves
(\ie{} existence of uniqueness of arrow extension from dense
$(-1)$-subobjects), with the condition that all its path types are
$n$-sheaves. This is a way to force the compatibility of the modalities we
are defining.

One can check that the property $\issep$ (resp. $\issheaf$) is $\HProp$:
given a $X:\Type_{n+1}$, there is at most one way for it to be separated
(resp. a sheaf). In particular, when one needs to prove equality between
two sheaves, it suffices to show the equality between the underlying
types.

As mentioned earlier, these definitions allow us to prove the fundamental
property that the type of all $n$-sheaves is itself a $(n+1)$-sheaf
.

\begin{prop}[\thethm\ (\code{nType\_j\_Type\_is\_SnType\_j\_Type})]
\label{prop:sheaf-is-sheaf}
  $\Type_n^\modal$ is a $(n+1)$-sheaf.
\end{prop}

\begin{proof}
  We have two things to prove here: separation, and the sheaf property.
  \begin{itemize}
  \item Let $E:\Type$ and $\chi:E\to\Type$, dense in $E$. 
    Let $\phi_1,\phi_2:E \to
    \Type_n^\modal$, such that $\phi_1 \circ \pi_1 = \phi_2 \circ
    \pi_1$ and let $x:E$. We show $\phi_1(x) = \phi_2(x)$ using
    univalence.
    
    As $\chi$ is dense, we have a term $m_x : \modal_n(\chi\, x)$.
    But as $\phi_2(x)$ is modal, we can obtain a term $h_x : \chi\,
    x$. 
    As $\phi_1$ and $\phi_2$ are equal on $\sumD e E {\chi\, e}$, we
    have an arrow $\phi_1(x) \to \phi_2(x)$.
    The same method leads to an arrow $\phi_2 (x) \to \phi_1 (x)$, and
    one can
    prove that they are each other inverse.
  \item Now, we prove that $\Type_n^\modal$ is a sheaf. Let $E:\Type$ and
  $\chi:E \to \HProp$, dense in $E$. Let $f:\sum_{e:E} \chi\, e \to
  \Type_n^\modal$. We want to extend $f$ into a map $E \to \Type_n^\modal$.

  We define $g$ as $g(e) = \modal_n \left( \fib \phi {e} \right)$,
  where
  \[ \phi : \sum_{b:\sumD e E {\chi\, e}} (f\,
    b) \to E\]
  defined by $\phi(x) = (x_1)_1$.
  Using the following lemma, one can prove that the map $f\mapsto g$
  defines an inverse of $\Phi_E^\chi$.
  \begin{lem}[\thethm\ (\code{nj\_fibers\_compose})]
    Let $A,B,C:\Type_n$, $f:A\to B$ and $g:B\to C$.
    Then
    if all fibers of $f$ and $g$ are $n$-truncated, then
      \[\prodD c C {\left( \modal_n(\fib {g \circ f} c) \right) \simeq
      \modal_n \left(  
        \sumD w {\fib g c} {\modal_n (\fib f {w_1})}
      \right)}.\]
  \end{lem}
  \begin{proof}
    This is just a modal counterpart of the property characterizing
    the fibers of composition of functions.
  \end{proof}
  \end{itemize}
\end{proof}

Another fundamental property on sheaves we will need is that the type of (dependent)
functions is a sheaf as soon as its codomain is a sheaf.

\begin{prop}[\thethm\ (\code{dep\_prod\_SnType\_j\_Type})]
\label{prop:sheaf-forall}
  If $A:\Type_{n+1}$ and $B:A \to \Type_{n+1}$ such that for any
  $a:A$, $(B~a)$ is a sheaf, then $\prodD a A {B\, a}$ is a sheaf.
\end{prop}
\begin{proof}
  Again, when proving equivalences, we will only define the maps. The
  proofs of section and retraction are technical, not really
  interesting, and present in the formalization.
  \begin{itemize}
  \item {\em Separation:} Let $E:\Type$ and $\chi:E \to \Type_n$ dense
    in $E$. Let $\phi_1,\phi_2:E\to \prodD a A {B\, a}$ equal on
    $\sumD e E{\chi\, e}$ \ie{} such that $\phi_1\circ \pi_1 = \phi_2\circ
    \pi_1$.
    Then for any $a:A$, $(\lambda x:E,~\phi_1(x, a))$
    and $(\lambda x:E,~\phi_2(x,a))$
    coincide on $\sum_{e:E}(\chi\, e)$, and as $B\, a$ is separated,
    they coincide also on all $E$.
  \item {\em Sheaf:} Let $E:\Type$, $\chi:E\to \HProp$ dense in $E$ and
    $f:\sumD e E {\chi\, e}\to \prodD a A{B\,a}$. Let $a:A$; the
    map $(\lambda x,~f(x,a))$ is valued in the sheaf $B\, a$, so it
    can be extended to all $E$, allowing $f$ to be extended to all
    $E$.
  \end{itemize}
\end{proof}

\subsection{Sheafification}
\label{ssec:sheafification}

The sheafification process will be defined in two steps. First
one will build, from any $T:\Type_{n+1}$, a separated object $\separated
T:\Type_{n+1}$; one can then show that $\separated$ defines a modality on
$\Type_{n+1}$. Second, one builds, from any separated type
$T:\Type_{n+1}$, a sheaf $\modal_{n+1}(T)$; one can show that
$\modal_{n+1}$ is indeed the left-exact modality we are searching.

Let $n$ be a fixed truncation index, and $\modal_n$ a left-exact
modality on $\Type_n$, compatible with $\modal_{-1}$ as in
\begin{cond}\label{cond:hprop}
  For any mere proposition $P$ (where $\widehat P$ is $P$ seen as a
  $\Type_n$),  $\modal_n \widehat P = \modal_{-1} P$ and the
  following coherence diagram commutes
  \[\xymatrix{
    P \ar@{->}^{\sim}[r] \ar[d]_{\eta_{-1}} & \widehat P \ar[d]^{\eta_n} \\
    \modal_{-1} P \ar@{->}^{\sim}[r] & \modal_n \widehat P 
  }\]
\end{cond}

\subsubsection{From types to separated types}
\label{sssec:type_to_sep}


Let $T : \Type_{n+1}$. We define $\separated T$ as the image of
$\modal_n^T \circ \{\cdot\}_T$, as in
\[\xymatrix{
    T \ar[r]^{\{\cdot\}_T} \ar[d]_{\mu_T} & \left(\Type_n\right)^T \ar[d]^{\modal_n^T} \\
  \separated T \ar[r]& \left( \Type_n^\modal \right)^T
}, \]%
where $\{\cdot\}_T$ is the singleton map $\lambda (t:T),~\lambda
(t':T),~t=t'$. 
%
$\separated T$ can be given explicitly by
%
\begin{align*}
\separated T &\defeq \im (\lambda~t:T,~\lambda~ t',~ \modal_n (t = t')) \\
          &\defeq \sumD u{T \to \Type_n^\modal} {\left\| \sumD a A
            {(\lambda t,~\modal_n (a=t)) = u}\right\|}.
\end{align*}
%
This corresponds to the free separated object used in the topos-theoretic construction, but using $\Type_n^\modal$ instead of the
$j$-subobject classifier $\Omega_j$.
%
\begin{prop}[\thethm\ (\code{separated\_Type\_is\_separated})]
  For any $T:\Type_{n+1}$, $\separated T$ is separated.  
\end{prop}

\begin{proof}
We use the following lemma:
\begin{lem}[\thethm\ (\code{separated\_mono\_is\_separated})]
\label{lem:embed-sep}
  A $(n+1)$-truncated type $T$ with an embedding $f : T \to U$
  into a separated $(n+1)$-truncated type $U$ is itself separated.
\end{lem}
\begin{proof}
  Let $E:\Type$ and $\chi:E\to\Type_n$ dense in $E$. Let
  $\phi_1,\phi_2:\sumD e E {\chi\, e} \to T$ such that $\phi_1 \circ
  \pi_1 \homot \phi_2 \circ \pi_1$. Postcomposing by $f$ yields an homotopy $f \circ \phi_1 \circ
  \pi_1 \homot f \circ \phi_2 \circ \pi_1$. As $f\circ\phi_1,f\circ
  \phi_2 : \sumD e E {\chi\, e} \to U$, and $U$ is separated, we can
  deduce $f \circ \phi_1 \homot f \circ \phi_2$. As $f$ is an
  embedding, $\phi_1 \homot \phi_2$.
\end{proof}
As $\separated T$ embeds in $\left( \Type_n^\modal \right)^T$, we only
have to show that the latter is separated. But this is the case because
$\Type_n^\modal$ is a sheaf (by Proposition~\ref{prop:sheaf-is-sheaf})
and a function type is a sheaf as soon
as its codomain is a sheaf (by Proposition~\ref{prop:sheaf-forall}).
\end{proof}

We will now show that $\separated$ defines a modality, with unit map
$\mu$. The left-exactness of $\modal_{n+1}$ will come from the second
part of the process.
The first thing to show is that $\separated T$
is universal among separated types below $T$. 
In the topos-theoretic sheafification, it comes easily from the fact
that epimorphims are coequalizers of their kernel pairs. As it is not
true anymore in our setting, we will use its generalization, the
proposition~\ref{cech}.
Here is a sketch of the proof:
as $\mu_T$ is a surjection (it is defined by the surjection-embedding
factorization), $\separated T$ is the colimit of its iterated kernel
pair. Hence, for any type $Q$ defining a cocone on $\KP(\mu_T)$, there
is a unique arrow $\separated T\to Q$. What remains to show is that any
separated type $Q$ defines a cocone on $\KP(\mu_T)$; we will actually
show that any separated type $Q$ defines a cocone on
$\|\KP(\mu_T)\|_{n+1}$, which is enough. We do it by
defining another diagram $\mathring T$, equivalent to $\|\KP(\mu_T)\|_{n+1}$, for
which it is easy to define a cocone into any separated type $Q$.


This comes from the
following construction which connects $\separated T$ to the colimit of
the iterated kernel pair of $\mu_T$.

\begin{defi}[\thethm\ (\code{OTid})]
  Let $X:\Type$. Let $\mathring T_X$ be the higher inductive type
  generated by
  \begin{itemize}
  \item $\mathring t:~\|X\|_{n+1} \to \mathring T_X$
  \item $\mathring \alpha:~\forall a\, b:\|X\|_{n+1},~\modal (a=b) \to
    \mathring t(a) = \mathring t(b)$
  \item $\mathring \alpha_1:~\forall a:\|X\|_{n+1},~
    \mathring \alpha(a , a, \eta_{a=a} 1) = 1$
  \end{itemize}

  We view $\mathring T$ as the coequalizer of
  \[
    \xymatrix{\displaystyle{\sumD {a,b}{\|X\|_{n+1}} {\modal (a=b)}} \ar@<-.5ex>[r]_-{\pi_2} \ar@<.5ex>[r]^-{\pi_1}
      & \|X\|_{n+1}
    }\]%
  preserving $\eta_{a=a} 1$.

  We consider the diagram $\mathring T$ :
  \[\xymatrix{\|X\|_{n+1} \ar[r] & \|\mathring T_{X}\|_{n+1} \ar[r] & \|\mathring
  T_{\mathring T_X} \|_{n+1} \ar[r] & \cdots} \]%
\end{defi}


The main result we want about $\mathring T$ is the following:
\begin{lem}[\thethm\ (\code{separation\_colimit\_OTtelescope})]
\label{lem:sepiscolim}
  Let $T:\Type_{n+1}$. Then $\separated T$ is the $(n+1)$-colimit of the
  diagram $\mathring T$.
\end{lem}

The key point of the proof is that diagrams $\mathring T$ and $\|\KP(\mu_T)\|_{n+1}$
are equivalent.
We will need the following lemma:

\begin{lem}[\thethm\ (\code{OT\_Omono\_sep})]
\label{lem:Omono}
  Let $A,S:\Type_{n+1}$, $S$ separated, and $f:A \to S$. Then if 
  \begin{equation}
    \label{eq:Omono}
    \forall a,b:A,~f (a) = f (b) \simeq \modal (a=b),
  \end{equation}
  then
  \[\forall a,b:\|\KP_f\|_{n+1},~|\tilde f|_{n+1} (a) = |\tilde f|_{n+1} (b) \simeq \modal (a=b).\]
\end{lem}

\begin{proof}[(Sketch)]
  By induction on truncation, we need to show that 
  \[\forall a,b:\KP_f,~\tilde f (|a|_{n+1}) = \tilde f (|b|_{n+1} )\simeq
  \modal (|a|_{n+1}=|b|_{n+1}).\]%
  We use the encode-decode~\cite[Section 8.9]{hottbook} method to characterize $\tilde f (|a|_{n+1})
  = x$, and the result follows. We refer to the formalization for details.
\end{proof}

This lemma allows one to prove that, in the iterated kernel pair diagram
of $f$
\[
  \xymatrix{
    X \ar[r] \ar[rrd]_f & \KP(f) \ar[r] \ar[rd]^{f_1} & \KP(f_1)
    \ar[r] \ar[d]_{f_2} & \KP(f_2) \ar[r] \ar[ld]^{f_3}& \cdots \\
    && S &&
  }
\]
if $f$ satisfies~(\ref{eq:Omono}), then each $|f_i|_{n+1}$ does.

\begin{rmq}
It is clear that if $A$ and $B$ are equivalent types, and for all $a,b:A,~f (a) = f (b) \simeq \modal
(a=b)$, then 
\[
    \mathrm{Coeq}_1 \left( 
      \xymatrix{
        \displaystyle{\sumD {a,b} A {f a = f b}} \ar@<-.5ex>[r]_-{\pi_2} \ar@<.5ex>[r]^-{\pi_1} & A
      }
    \right)
    \simeq \mathrm{Coeq}_1 \left( 
      \xymatrix{\displaystyle{\sumD {a,b} B {\modal (a=b)}} \ar@<-.5ex>[r]_-{\pi_2} \ar@<.5ex>[r]^-{\pi_1} & B}
    \right)
  \]
\end{rmq}

\begin{proof}[of lemma~\ref{lem:sepiscolim}]
  As said, it suffices to show that $\|C(\mu_T)\|_{n+1} =
  \mathring T$.

  \[
    \xymatrix{%
     \|\KP^0(\mu_T)\|_{n+1} \ar[r] \ar[d]^*[@]{\hbox to 0pt{\hss$\sim$\hss}}&
     \|\KP^1(\mu_T)\|_{n+1} \ar[r] \ar[d]^*[@]{\hbox to
       0pt{\hss$\sim$\hss}} & 
     \|\KP^2(\mu_T)\|_{n+1} \ar[r] \ar[d]^*[@]{\hbox to
       0pt{\hss$\sim$\hss}} & \cdots \\
     \mathring T_0 \ar[r] & \mathring T_1 \ar[r] &  \mathring T_2
     \ar[r] &\cdots
    }
  \]
  The first equivalence is trivial, so let us begin with the
  second. What we need to show is
  \[ \|\KP(\mu_T)\|_{n+1} \simeq \|\mathring T_T\|_{n+1}, \]
  \ie{}
  \[
    \mathrm{Coeq}_1 \left( 
      \xymatrix{
        \displaystyle{\sumD {a,b} T {\mu_T a = \mu_T b}} \ar@<-.5ex>[r]_-{\pi_2} \ar@<.5ex>[r]^-{\pi_1} & T
      }
    \right)
    \simeq \mathrm{Coeq}_1 \left( 
      \xymatrix{\displaystyle{\sumD {a,b} T{\modal (a=b)}} \ar@<-.5ex>[r]_-{\pi_2} \ar@<.5ex>[r]^-{\pi_1} & T}
    \right).
  \]
  
  By the previous remark, it suffices to show that $\mu_T$ satisfies condition~(\ref{eq:Omono}),
  \ie{} $\prodD {a,b} T {\modal_n (a=b) = (\mu_T a =
  \mu_T b)}$. By univalence, we want arrows in both directions, forming an
  equivalence.
  \begin{itemize}
  \item Suppose $p : (\mu_T a = \mu_T b)$. Then projecting $p$ along
    first components yields $q : \prodD t T {\modal_n(a=t)} = \modal_n (b=t)
    $.
    Taking for example $t=b$, we deduce $\modal_n (a=b) = \modal_n(b=b)$,
    and the latter is inhabited by $\eta_{b=b} 1$.
  \item Suppose now $p : \modal_n(a=b)$. Let $\iota$ be the first
    projection from $\separated T \to (T \to \Type_n^\modal)$. $\iota$ is
    an embedding, thus it suffices to prove $\iota (\mu_T a) = \iota
    (\mu_T b)$, \ie{} $\prodD t T{\modal_n (a=t) = \modal_n (b=t)}$. The latter
    remains true by univalence.
  \end{itemize}
  As the fact that these two form an equivalence is rather technical,
  we refer to the formalization for an explicit proof.


  Let us now show the other equivalences by induction. Suppose that, for a
  given $i:\N$, $\|\KP^i(\mu_T)\|_{n+1} \simeq \mathring T_i$. We want
  to prove $\|\KP^{i+1}(\mu_T)\|_{n+1} \simeq \mathring T_{i+1}$, \ie{}

  \[
    \begin{split}
    \left\|\mathrm{Coeq}_1 \left( 
      \xymatrix{
        \displaystyle{\sumD {a,b}{\KP^i(\mu_T)} {f_{i} a = f_{i} b}} \ar@<-.5ex>[r]_-{\pi_2} \ar@<.5ex>[r]^-{\pi_1} & \KP^i(\mu_T)
      }
    \right)\right\|_{n+1}
    \\ \simeq 
    \left\|\mathrm{Coeq}_1 \left( 
      \xymatrix{\displaystyle{\sumD {a,b} {\|\mathring T_i\|_{n+1}} {\modal (a=b)}} \ar@<-.5ex>[r]_-{\pi_2} \ar@<.5ex>[r]^-{\pi_1} & \|\mathring T_i\|_{n+1}}
    \right)\right\|_{n+1}
    \end{split}
  \]
  where $f_{i}$ is the map $\KP^i(\mu_T) \to \separated T$. But
  lemma~\ref{lem:Omono} just asserted that $f_i$
  satisfies~(\ref{eq:Omono}), hence the previous yields the result.
  
  Next one would need to show that, modulo these equivalences, the arrows
  of the two diagrams are equal. We leave that to the reader, who can
  refer to the formalization if needed.
\end{proof}

Now, let $Q$ be any separated $\Type_{n+1}$, and $f:X \to Q$. Then the
following diagram commutes

\[\xymatrix{
\|X\|_{n+1} \ar[r] \ar[rd] & \|\mathring T_{X}\|_{n+1} \ar[r] \ar[d] & \|\mathring
  T_{\mathring T_X} \|_{n+1} \ar[ld] \ar[r] & \cdots \\
  & Q &&
} \]% 

But we know (lemma~\ref{lem:sepiscolim}) that $\separated T$ is the
$(n+1)$-colimit of the diagram $\mathring T$, thus there is an universal
arrow $\separated T \to Q$.
%
This is enough to state the following proposition.
\begin{prop}[\thethm\ (\code{separation\_reflective\_subuniverse})]
\label{prop:sep-subu}
  $(\separated,\mu)$ defines a reflective subuniverse on $\Type_{n+1}$.
\end{prop}

To show that $\separated$ is a modality, it remains to show that
separation is a property stable under sigma-types.
%
Let $A:\Type_{n+1}$ be a separated type and $B:A \to \Type_{n+1}$ be a
family of separated types. We want to show that $\sumD x A {B\, x}$ is separated. Let $E$
be a type, and $\chi:E\to\Type_n$ a dense subobject of E.

Let $f,g$ be two maps from $\sumD e E {\chi\,e}$ to $\sumD x A
{B\, x}$, equal when precomposed with $\pi_1$.
\[\xymatrix @R=4em @C=4em{
  \sumD e E {\chi\, e} \ar@<-2pt>[r]_{g\circ\pi_1}
  \ar@<2pt>[r]^{f\circ \pi_1} \ar[d]_{\mathrm{dense}}& \sumD x A {B\, x} \\
  E \ar@<-2pt>[ru]_{g} \ar@<2pt>[ru]^{f}&
}\]%
We can restrict the previous diagram to 
\[\xymatrix @R=4em @C=5em{
  \sumD e E {\chi\, e} \ar@<-2pt>[r]_{\pi_1\circ g\circ\pi_1} \ar@<2pt>[r]^{\pi_1\circ f\circ \pi_1} \ar[d]_{\mathrm{dense}}& A \\
  E \ar@<-2pt>[ru]_{\pi_1\circ g} \ar@<2pt>[ru]^{\pi_1\circ f}&
}\]%
and as $A$ is separated, $\pi_1\circ f = \pi_1 \circ g$.
For the second components, let $x:E$. Notice that 
$\sumD y E {x = y}$ has a dense $n$-subobject, $\sumD y {\sumD e E {\chi\,
  e}} {x=y_1}$:

\[\xymatrix@C=8em@R=4em{
  \sumD y {\sumD e E {\chi\,
  e}} {x=y_1} \ar@<2pt>[r]^{\qquad \pi_2\circ f\circ\pi_1\circ \pi_1}
\ar@<-2pt>[r]_{\qquad \pi_2\circ g\circ \pi_1\circ \pi_1}
\ar[d]_{\mathrm{dense}}& B\,x \\
  \sumD y E {x = y} \ar@<2pt>[ur]^{\pi_2\circ f\circ \pi_1} \ar@<-2pt>[ur]_{\pi_2\circ g\circ \pi_1}&
}\]%
Using the separation property of $B\,x$, one can show that second
components, correctly transported along the first component's equality,
are themselves equal. The complete proof can be found in the formalization.
This proves the following proposition
\begin{prop}[\thethm\ (\code{separated\_modality})]
\label{prop:sep-mod}
  $(\separated,\mu)$ defines a truncated modality on $\Type_{n+1}$.
\end{prop}

As this modality forms just one step in our construction, we do not need to
show that it is left exact.  This we will do only for the sheafification
modality.

\subsubsection{From Separated Type to Sheaf}
\label{sssec:separated-to-sheaf}

%\nt{put the definition of $\modal_{n+1}$ upfront}
For any $T$ in $\Type_{n+1}$, 
$\modal_{n+1}T$ is defined as the closure of $\separated T$,
seen as a subobject of $T \to \Type_n^\modal$. 
%
$\modal_{n+1}T$ can be given explicitly by
\[
\modal_{n+1} T \ \defeq \sum_{u:T \to \Type_n^\modal} \modal_{-1}\left\| \sum_{a:T} 
            (\lambda t,~\modal_n (a=t)) = u\right\|.
\]%

To prove that $\modal_{n+1} T$ is a sheaf for any $T:\Type_{n+1}$, we
use the following lemma.
\begin{lem}[\thethm\ (\code{closed\_to\_sheaf})]
  Any closed $(-1)$-subobject of a sheaf is a sheaf.
  % Let $X:\Type_{n+1}$ and $U$ be a sheaf. If $X$ embeds
  % in $U$, and is closed in $U$, then $X$ is a sheaf.
\end{lem}
\begin{proof}
  Let $U$ be a sheaf, and $\kappa:U\to \HProp$ be a closed
  $(-1)$-subobject. 
  Let $E:\Type$ and
  $\chi:E\to\HProp$ dense in $E$. Let $\phi:\sumD e E {\chi\, e} \to
  \sumD u U {\kappa\, u}$. As $\pi_1 \circ \phi$ is a map $\sumD e E
  {\chi\, e} \to U$ and $U$ is a sheaf, it can be extended into
  $\psi:E\to U$. As $\kappa$ is closed, it suffices now to prove
  $\prodD e E {\modal_n(\kappa\, (\psi\, e))}$ to obtain a map
  $E\to\sumD u U {\kappa\, u}$.

  Let $e:E$. As $\chi$ is dense, we have a term $w:\modal_n(\chi\,e)$,
  and by $\modal_n$-induction, a term $\widetilde w:\chi\, e$.
  Then, by the retraction property, $\psi(e) = \phi(e,\widetilde w)$, and by $\pi_2
  \circ \phi$, we have hence our term of type $\kappa(\psi\, e)$.



  % Let $f:X\to U$ be the considered embedding. We have already seen in
  % lemma~\ref{lem:embed-sep} that, as $U$ is separated, $X$ is too.

  % Let $E:\Type$ and
  % $\chi:E\to\HProp$ dense in $E$. Let $\phi:\sumD e E {\chi\, e} \to
  % X$. Then $f\circ \phi$ can be extended to a map $g:E\to U$.
\end{proof}
As $T\to \Type_n^\modal$ is a sheaf, and $\modal_{n+1}T$ is closed in
$T\to \Type_n^\modal$, $\modal_{n+1}T$ is a sheaf. We now prove that
it forms a reflective subuniverse.

\begin{prop}[\thethm\ (\code{sheafification\_subu})]
  $(\modal_{n+1},\nu)$ defines a reflective subuniverse.
\end{prop}
\begin{proof}
  Let $T,Q:\Type_{n+1}$ such that $Q$ is a sheaf. Let $f:T\to Q$.
  Because $Q$ is a sheaf, it is in particular separated;
  % 
  thus we can extend $f$ to $\separated f:\separated T\to Q$.

  But as $\modal_{n+1} T$ is the closure of $\separated T$, $\separated T$ is dense
  into $\modal_{n+1} T$, so the sheaf property of $Q$ allows to extend
  $\separated f$ to $\modal_{n+1} f:\modal_{n+1} T \to Q$.

  As all these steps are universal, so is the composition.
\end{proof}

% Using the same technique as in proposition~\ref{prop:sep-mod}, we
% have
The next step is the closure under dependent sums, specifically:
\begin{prop}[\thethm\ (\code{sheafification\_modality})]
  $(\modal_{n+1},\nu)$ defines a modality.
\end{prop}
\begin{proof}
  The proof uses the same ideas as in
  subsection~\ref{sssec:type_to_sep}. Let $A:\Type_{n+1}$ a sheaf and
  $B:A\to\Type_{n+1}$ a sheaf family. By
  proposition~\ref{prop:sep-mod}, we already know that $\sumD a A {B\,
    a}$ is separated. Let $E$ be a type, and $\chi:E\to \HProp$ a
  dense subobject. Let $f:\sumD e E {\chi\, e} \to \sumD x A {B\, x}$
 ; we want to extend it into a map $E\to \sumD x A {B\, x}$.

  \[
    \xymatrix{
      \sumD e E {\chi\, e} \ar[r]^f \ar[d] & \sumD x A {B\, x} \\
      E \ar@{.>}[ru]&
    }
  \]

  As $A$ is a sheaf, and $\pi_1\circ f:\sumD e E {\chi\, e}
  \to A$, we can recover a map $g_1:E \to A$. We then want to show
  $\prodD e E {B(g_1\, e)}$. Let $e:E$. As $\chi$ is dense, we have a
  term $w:\modal_n(\chi\, e)$, and as $B(g_1\, e)$ is a sheaf, we can
  recover a term $\widetilde w:\chi\, e$. Then $g_1(e) =
  f(e,\widetilde w)$, and $\pi_2\circ f$ gives the result.
\end{proof}

It remains to show that $\modal_{n+1}$ is left exact and is compatible
with $\modal_{-1}$. To do that, we need to extend the notion of
compatibility and show that, in fact, every modality $\modal_{n+1}$ is
compatible with $\modal_n$ on lower homotopy types.
\begin{prop} \label{prop:compatibility}
  If $T:\Type_n$, then $\modal_{n+1} \widehat T = \modal_n T$, where $\widehat T$ is $T$ seen as a
  $\Type_{n+1}$.
\end{prop}
\begin{proof}
  We prove it by induction on $n$:
  \begin{itemize}
  \item For $n=-1$: Let $T:\HProp$. Then
    \begin{align*}
      \modal_{0} \widehat T &\defeq \sum_{u:T \to \Type_n^\modal} \modal_{-1}\left\| \sum_{a:T} 
      (\lambda t,~\modal_{-1} (a=t)) = u\right\|_{-1} \\
      &= \sum_{u:T \to \Type_n^\modal} \modal_{-1}\left( \sum_{a:T} 
      (\lambda t,~\modal_{-1} (a=t)) = u\right)
    \end{align*}
    because the type inside the truncation is already in $\HProp$.
    Now, let define $\phi : \modal_{-1} T \to \modal_0T$ by
    \[\phi t = (\lambda t',\, \one
      ;\kappa)\]%
    where $\kappa$ is defined by $\modal_{-1}$-induction on
    $t$. Indeed, as $T$ is an $\HProp$, $(a=t) \simeq \one$. 
    Let $\psi : \modal_0T\to \modal_{-1} T$ by obtaining the
    witness $a:T$ (which is possible because we are trying to inhabit
    a modal proposition), and letting $\psi (u;x) = \eta_T a$.
    These two maps form an equivalence (the section and retraction are
    trivial because the equivalence is between mere propositions).
  \item Suppose now that $\modal_{n+1}$ is compatible with all $\modal_k$ on
    lower homotopy types. Let $\modal_{n+2}$ be as above, and let
    $T:\Type_{n+1}$. Then, as $\modal_{n+1}$ is compatible with $\modal_{n}$, and
    $(a=t)$ is in $\Type_n$,
    \[
      \modal_{n+2} \widehat T= \hspace{-1em} \sum_{u:T \to
        \Type_{n+1}^\modal} 
      \hspace{-1em} \modal_{-1}\left\| \sum_{a:T} 
        (\lambda t,~\modal_{n} (a=t)) = u\right\|_{-1}.
    \]%
    It remains to prove that for every $(u,x)$ inhabiting the
    $\Sigma$-type above, $u$ is in $T\to\Type_n^\modal$, \ie{} that for
    every $t:T$, $\IsType n (u\, t)$.  But for any truncation index
    $p$,
    the type $\IsType p X:\HProp$ is a sheaf as soon as $X$ is, so we can get rid
    of $\modal_{-1}$ and of the truncation, which tells us that for
    every 
    $t:T$, $u\, t = \modal_n(a=t) : \Type_n$. 
  \end{itemize}
\end{proof}
This proves in particular that $\modal_{n+1}$ is compatible with
$\modal_{-1}$ in the sense of condition~\ref{cond:hprop}.

The last step is the left-exactness of $\modal_{n+1}$. Let $T$ be in
$\Type_{n+1}$ such that $\modal_{n+1} T$ is contractible.  Thanks to the just
shown compatibility between $\modal_{n+1}$ and $\modal_n$ for
$\Type_n$, left-exactness means that for any $x,y: T$,
$\modal_n(x=y)$ is contractible.

Using a proof by univalence as we have done for proving $\modal_n (a=b) \simeq (\mu_T(a) =
\mu_T (b))$ in Proposition~\ref{lem:sepiscolim}, we can show that:
\begin{prop}[\thethm\ (\code{good\_sheafification\_unit\_paths\_are\_nj\_paths})]
  For all $a,b:T$, $\modal_n(a=b) \simeq (\nu_T a = \nu_T b)$.
\end{prop}

As $\modal_{n+1} T$ is contractible, path spaces of $\modal_{n+1} T$ are
contractible, in particular $(\nu_T a=\nu_T b)$, which proves left
exactness.

\subsection{Summary}
\label{ssec:summary}

Starting from any left-exact modality $\modal_{-1}$ on $\HProp$, we
have defined for any truncation level $n$, a new left-exact modality
$\modal_n$ on $\Type_n$, which corresponds to $\modal_{-1}$ when
restricted to $\HProp$.


When $\modal_{-1}$ is consistent (in the sense of
section~\ref{ssec:new-type-theories}), 
$\modal_{n}\zero=\modal_{-1}\zero$ is also not inhabited, hence
$\modal_n$ is consistent. 
%
In particular, the modality induced by the double negation modality on
$\HProp$ is consistent.

In topos theory, the topos of Lawvere-Tierney sheaves for the double
negation topology is a boolean topos. In homotopy type theory, this
result can be expressed as:

\begin{prop}
  Taking $(\modal_{\lnot\lnot})_n$, the modality obtained by
  sheafification of the double negation modality,
  the following holds
  \[
    \prodD P {\HProp} {\modal_{\lnot\lnot} (P + \lnot P)}.
  \]
\end{prop}
\begin{proof}
 Let $P:\HProp$, and pose $Q \defeq P + \lnot P$. Then, as
  $P$ and $\lnot P$ are disjoint h-propositions, $P + \lnot P$ is
  itself a h-proposition~\cite[\texttt{ishprop\_sum}]{hottlib}.
  Thus, $\modal_{\lnot\lnot} Q \simeq \lnot\lnot Q$, and the latter is
  inhabited by the usual
  \[
    \lambda\, (x:\lnot Q),\, x(\inr (\lambda\, y:P,\, x(\inl y))).
  \]
\end{proof}


% Combined with forcing in type theory~\cite{jaber2012extending}, it
% should be possible to lift the proof of independence of the continuum
% hypothesis to a classical setting, which is where the continuum hypothesis is
% really meaningful.  However, we haven't worked out the details and left
% this for future work.


\subsection{Extension to Type}
\label{ssec:extension-type}

In the previous section, we have defined a (countably) infinite family of
modalities $\Type_i \to \Type_i$. One can extend them to whole
$\Type$ by composing with truncation:

\begin{lem}\label{lem:type}
  Let $\modal_i:\Type_i \to \Type_i$ be a modality. Then $\modal
  \defeq \modal_i
  \circ \|\cdot\|_i : \Type \to \Type$ is a modality in the sense
  of section~\ref{sec:modalities}
\end{lem}
\begin{proof}
  It is straightforward to check each property of a modality.
\end{proof}
If $\modal_{-1}$ is the double negation modality on $\HProp$ and
$i=-1$, $\modal$ is exactly the double negation modality on $\Type$
described in~\ref{sssec:notnot}.
Choosing $i\geqslant 0$ is a refinement of this double negation
modality on $\Type$: it will collapse every type to a $\Type_i$,
instead of an $\HProp$.

Obviously, as truncation modalities are not left-exact~\cite[Exercise
7.11]{hottbook}, $\modal$ isn't either. But in the following sense, when
restricted to $i$-truncated types, it is:
\begin{lem}
  Let $A:\Type_i$. Then if $\modal(A)$ is contractible, for any $x,y:A$,
  $\modal(x=y)$ is contractible.
\end{lem}
\begin{proof}
  For $i$-truncated types, $\modal = \modal_i$, and $\modal_i$ is left-exact.
\end{proof}

The compatibility between the modalities $\modal_n$ and between the
modalities $\|\cdot \|_n$ allows us to take the truncation index as
high as desired.
Taking it as a non-fixed parameter allows one to work in a
universe where the new principle ({\em e.g.} mere excluded middle) is
true for any explicit truncated type. Indeed, $i$ can be chosen
dynamically along a proof, and thus be increased as much as needed,
without changing results for lower truncated types.

% By proposition~\ref{prop:consistent}, these left-exact modalities
% induces a consistent type theory.
Furthermore, univalence remains
true in this new type theory in the following sense:
\begin{prop}\label{prop:univalence}
  Let $n$ be a given truncation index, and $\modal$ the modality
  associated to $n$ as defined in lemma~\ref{lem:type}. Then, for
  any type $A,B:\Type_n^\modal$, if $\varphi$ is the canonical arrow
  $$A = B \to A\simeq B,$$
  then $\IsEquiv(\varphi)$ is modal.
\end{prop}
\begin{proof}
  The first thing to notice is that, if $X$ and $Y$ are modal, and
  $f:X \to Y$, then the mere proposition $\IsEquiv f$ is also modal.
  Therefore, it suffices to show that both $A=B$ and $A\simeq B$ are
  modal. By proposition~\ref{prop:mod_prop}, $A=B$ is modal. 
  Moreover, $(A\simeq B) \simeq \sum_{f:A\to B} \IsEquiv
  f$. Therefore, as $A$ and $B$ are modal, $A\simeq B$ is too. 

  Hence, $\IsEquiv \varphi$ is modal.
\end{proof}

% We can view sheafification in terms of model of type theory but
% because of the resulting modality on $\Type$ is not left exact, we
% need to restrict ourselves to a type theory with only one universe.
% %
% Let $\mathfrak M$ be a model of homotopy type theory with one
% universe.
% %
% Using the modality $\modal_{\lnot \lnot}$ (for any level $n$) associated to the
% sheafification, there is a model $\modal_{\lnot \lnot} \mathfrak M$ of type theory
% with one universe (using results in
% Section~\ref{sec:new-type-theories}), where excluded middle is true, and
% which is univalent (as shown in Proposition~\ref{prop:univalence}).
% %

\section{Formalization}
\label{sec:sheaf-formalization}

A Coq formalization of the sheafification process based on the
Coq/HoTT library~\cite{hottlib} is available at
\url{https://github.com/KevinQuirin/sheafification}.

After reviewing the content and some statistics about the
formalization in Section~\ref{ssec:cont-form}, we present the
limitations of our formalization in Section~\ref{ssec:limit-form}, in
particular the issues relative to universe polymorphism. 

\subsection{Content of the formalization}
\label{ssec:cont-form}

We provide a more detailed insight of the structure of our formalization:
\begin{itemize} 
\item Colimits and iterated kernel pairs are formalized in
\texttt{Limit}, \texttt{T.v}, \texttt{OT.v}v \texttt{OT\_Tf.v}, \texttt{T\_telescope.v}, \texttt{Tf\_Omono\_sep.v}.% (552 lines).
\item
Reflective subuniverses and modalities are formalized in\\
\texttt{reflective\_subuniverse.v}, \texttt{modalities.v}. % (1053 lines).
\item 
%
  The definition of the dense topology as a left exact modality on
  $\HProp$ is given in \texttt{sheaf\_base\_case.v}. % (186 lines).
\item
Section~\ref{ssec:sheaves} is formalized in
\texttt{sheaf\_def\_and\_thm.v}. % (1029 lines).
\item
Section~\ref{ssec:sheafification} is formalized in
\texttt{sheaf\_induction.v}. % (2340 lines).
\end{itemize}

Overall, % with other files containing technical lemmas,
the project
contains 8000 lines. This, however, could be reduced a bit by improving the
way Coq tries to rewrite and apply lemmas automatically. 
The \texttt{coqwc} tool counts 1600 lines of specifications
(definitions, lemmas, theorems, propositions) and 5500 lines of proof
script.
%
This constitutes a significant amount of work but the part dedicated
to sheaves and sheafification is only 2200 lines of proof script,
which seems quite reasonable and encouraging. Moreover it suggests
that homotopy type theory provides a convenient tool in which to formalize some
parts of the theory of higher toposes. 

\subsection{Limitations of the formalization}
\label{ssec:limit-form}

In the formalization, we we forced to use the \texttt{type-in-type} option to handle
the universe issues we faced. However, a lot of the code compiles
without this flag (but still needs universe polymorphism). 

Universes are used in type theory to ensure consistency by checking
that definitions are well-stratified according to a certain hierarchy.
%
Universe polymorphism~\cite{sozeau2014universe} supports generic
definitions over universes, reusable at different levels.
%
Although the presence of universe polymorphism is mandatory for our
formalization, its implementation is still too rigid to allow a
complete formalization of our work for the following reasons.

%
While Coq handles cumulativity on $\Type$ natively, this is not
the case for the $\Sigma$-type $\Type_n$, which requires propositional
resizing. 
%
This issue could be solved by adding an axiom of cumulativity
for $\Type_n$ with an explicit management of universes. 
%
However, as it would not have any computational content, such a solution
would needlessly complicate the proofs. Indeed, the axiom would then appear
everywhere cumulativity is needed and one would need explicit
annotations for universe levels throughout the formalization.
%
% Note that we also could have resolved the issue by giving explicitely
% the universe levels we wanted, like in the Coq/HoTT library\cite{hottlib}.

One issue with universe polymorphism lies in the management of
recursive definitions. Indeed, the following recursive definition of
sheafification

%
% \vspace{-0.05em}
\[ \begin{array}{l}
   \modal : \forall \ (n : nat), \ \Type_n \to \Type_n 
   \\
    \modal_{-1\phantom{n}}(T) \defeq\lnot\lnot T \\

      \displaystyle{\modal_{n+1}(T)} \defeq  
      \displaystyle{\sum_{u:T \to \Type_n^\modal} \!\!\!\!\modal_{-1} 
      \left\|
      \sum_{a:T} u= (\lambda t,~\modal_n (a=t))
      \right\|}
    \end{array}
% \vspace{-0.3em}
\]
%
is not allowed. 
%
This is because Coq forces the universe of the first $\Type_n$
occurring in the definition to be the same for every $n$, whereas the
universe of the first $\Type_{n+1}$ occurring in $\modal_{n+1}$ should be at
least one level higher as the one of $\Type_n$ occurring in
$\modal_{n}$ because of the use of $\Sigma$-type over
$T \to \Type_n^\modal$ and equality on the return type of $\modal_n$.
%
% \nt{explain why it is an issue.}
%
Thus, the induction step presented in this paper has been formalized,
but the complete recursive sheafification can not be defined for the
moment.
%
Note that the same increase in the universe levels occurs in the
Rezk completion of categories~\cite{rezk}. In the definition of the
completion, one uses the Yoneda embedding and representable functors,
which is similar in spirit to our use of characteristic functions.
 
%
This restriction in our formalization may be solved by
generalizing the management of universe polymorphism for recursive definitions
%
or by the use of more general ``resizing axioms'' which are still under
discussion in the community.
 

\section{Conclusion and Future Works}
\label{sec:future-works}

In this paper, we have demonstrated a way to extend Lawvere-Tierney
sheafification to truncated types in homotopy type theory. 

%
Above and beyond this individual result, our work is part of a larger program
which aims to illustrate that homotopy type theory is a promising
candidate for the formalization of mathematics inside a proof assistant.

% \nt{Add something on the definition of a syntactic translation as it
  % has been done for forcing.}

In future work, we would like to improve this construction in three
ways.
% \begin{itemize}
% \item 
(i) The extension to whole $\Type$ in lemma~\ref{lem:type} is not
  totally satisfactory, as every type is collapsed to a truncated
  one. But some types in homotopy type theory are not
  truncated~\cite[Example 8.8.6]{hottbook}.
  % At the moment, sheafification only works with truncated
  % types. This is fine from a programming point of view, 
  % but many important types in homotopy theory are not
  % truncated, \eg the circle $\mathbb S^2$.  Thus, we plan to extend
  % the sheafification to all types by using a
  % limit construction.
% \item 
(ii) 
  We would like to have more examples of left-exact modalities on
  $\HProp$, in order to have sheaves for different properties than
  excluded middle.
% \item 
% (iii) It would be useful to improve the translation induced by the
%   sheafification modality to preserve more definitional equalities.
%   %
%   This could be done for instance by defining a higher inductive type
%   isomorphic to the modality but with a better computational content. 
  % able to work in the new type theory into a proof assistant.
% \end{itemize}
%
(iii) In topos theory, Lawvere-Tierney subsumes Grothendieck~\cite[Section~V.4]{maclanemoerdijk} in the sense that any
Grothendieck topology gives rise to a Lawvere-Tierney topology with
the same notion of sheaves. Higher Lawvere-Tierney sheaves are
presented here, and higher Grothendieck sheaves have been defined
in~\cite{lurie}. It should be interesting to check if the subsumption
remains true in higher topos theory.

Moreover, we highly suspect that modalities (at least, left-exact
accessible modalities) induces new type theories, as Grothendieck
sheaves exhibits some $(\infty,1)$-subtoposes. It would be nice to
give a better sense to sub-type theories and to instantiate them with
sheafification, giving, for example, a model of homotopy type theory with
computational mere excluded middle.

% \section*{Acknowledgments}

\begin{acks}
  

We would like to thank all maintainers of the Coq/HoTT library, who
have provided a very solid base for our formalization. 
%
We also would like to thank Bas Spitters for helpful discussions on
the subject.
%
This work has been funded by the CoqHoTT ERC Grant 637339.
\end{acks}


\bibliographystyle{alpha}
\bibliography{biblio}


% \section{The Title Page}

% \subsection{The Title, Author(s), and Abstract}

% Following order is mandatory to generate a correct title page:

% \begin{verbatim}
% 		      \documentstyle{jfrarticle}
% 		      \title{}
% 		      \author{}{}
% 		      \begin{abstract} ...  \end{abstract}
% 		      \begin{document}
% 		      \begin{bottomstuff} ... \end{bottomstuff}
% 		      \maketitle
% \end{verbatim}

% \subsubsection{Title and Author}
% The \LaTeX\ \verb|\title| and \verb|\author| declarations and the
% \verb|\maketitle| command are similar to the usual ones, with some peculiarities.
% The \verb|\title| declaration allows one optional parameter containing a short title, to be used in the headings of the article. The \verb|\author| declaration requires two parameters, the first being the list of the authors in short, and the second one being the full list of authors, including their affiliation. The short list must be specified as follows:

% \begin{itemize}
% \item If there is one author, then use author's full name (ex. Leslie Lamport);
% \item If there are two authors, then abbreviate each author's first name
%            (L.~Lamport and A.~Appel);
% \item If there are more than two authors, then the format is Leslie Lamport et al.
% \end{itemize}

% The full list must follow the format illustrated in the following example:\cite{6:1:1}:
% \begin{quote}
% \begin{verbatim}
% \author{J.~E.~Archer, jr. et al.}
%         {JAMES E. ARCHER, JR.\\ Rational Machines
%         \and RICHARD CONWAY and FRED B. SCHNEIDER \\ 
%              Cornell University}
% \end{verbatim}
% \end{quote}
% Note that authors' names are in uppercase letters, authors are
% separated from their affiliation by a \verb|\\| command, multiple
% authors with the same affiliation are separated by ``and'' (or commas
% and ``and'' if there are more than two), and authors with different
% affiliations are separated by an \verb|\and| command.  The following
% example \cite{6:3:380} shows what to do if there are more than
% two affiliations:
% \begin{quote}
% \begin{verbatim}
% \author{E.~Korach et al.}
%         {E. KORACH \\ IBM Israel \\
%         D. ROTEM \\ University of Waterloo
%         \and N. SANTORO \\ Carleton University}
% \end{verbatim}
% \end{quote}
% In both the title and the author, you may have to insert \verb|\\|
% commands if lines need to be broken.

% \subsubsection{Abstract}
% The abstract is typed as usual with the {\tt abstract} environment.
% However, this environment must come before the \verb|\maketitle|
% command.

% \subsection{The Bottom of the Title Page}

% The bottom of the article's title page contains acknowledgment of
% support, the author(s) address(es), a ``permission to copy'' statement,
% and a line containing a copyright symbol (\copyright) and a mysterious
% number.  This is all entered with a {\tt bottomstuff} environment;
% there must be no blank line after the \verb|\begin{bottomstuff}|
% command.  The permission to copy statement is produced by the
% \verb|\permission| command.

% \section{Ordinary Text}

% Most of the body of the text is typed just as in an ordinary
% document.  This section lists the differences.

% \subsection{Lists}

% \subsubsection{Enumeration and Itemization}

% Let's begin with enumeration.
% \begin{longenum}
% \item The ACM style has two different formats for 
% itemized lists, which I will call the {\em long\/} and {\em short\/}
% formats.  The long format is generally used when the individual items
% are more than two or three lines long, but ACM has been inconsistent in
% their choice of format, sometimes using the long format for lists whose
% items are all one or two lines long and the short format for lists of
% long items.  This list is an example of the long format.

% \item The ordinary {\tt enumerate} environment
% produces the short format.  For the long format, use the
% {\tt longenum} environment.
% \begin{enumerate}\itemindent 10pt
% \item This inner enumeration uses the short format.
% \item It was produced using \LaTeX's ordinary {\tt enumerate}
%       environment.
% \item ACM has no standard for enumerations nested more than
%       two levels deep, so the {\tt acmtrans} style does not
%       handle them well.
% \end{enumerate}
% \end{longenum}

% Itemized lists are similar to enumerated ones.
% \begin{longitem}
% \item As with enumerations, there is a long and a short
% format for itemized lists.  This list is in the long format.

% \item The long format is produced by the {\tt longitem}
% environment.  The ordinary {\tt itemize} environment
% uses the short format.
% \begin{itemize}
% \item This is an itemized list using the short format.

% \item It was produced  with the {\tt itemize} environment
% that is used in ordinary \LaTeX\ input.
% \end{itemize}
% \end{longitem}

% It is interesting to observe that the style of tick mark used
% for an itemization changed around 1985 from an en dash
% (--) to an em dash (---). % jtb: changed!

% \subsubsection{Descriptions}

% A list is a sequence of displayed text elements, called items, each
% composed of the following two elements:
% \begin{describe}{{\em item body\/}:}
% \item[{\em label\/}:]
% A marker that identifies or sets off the item.  It
% is a number in an enumerated list and a tick mark in an itemized list.

% \item[{\em item body\/}:] The text of the item.  It is usually ordinary prose,
% but sometimes consists of an equation, a program statement, etc.

% Or another paragraph, which will be indented like normal paragraphs.
% \end{describe}

% When the labels of a list are names rather than numbers or tick marks,
% the list is called a {\em description\/} list.
% The ACM style
% has both long and short description lists.  The above list is a short
% description list; the bodies of all the items are indented enough to
% accommodate the widest label.
% The following list is a long description list.
% The {\tt acmtrans} style provides both kinds of description lists:
% \begin{description}
% \item[short]
% The {\tt describe} environment 
% %that works the
% %same as the {\tt description} environment except that it 
% takes an argument, which should be the same as the argument of the \verb|\item|
% command that produces the widest label.  Thus, the above description
% list was begun with the command
% \begin{quote}
% \begin{verbatim}
% \begin{describe}{{\em item body\/}:}
% \end{verbatim}
% \end{quote}

% A description label is often emphasized in some way; in this example I
% used the \LaTeX\ \verb|\em| command, italicized the label.  The ACM
% appears to have no standard convention for formatting the labels of a
% description list, so the {\tt describe} environment leaves the label
% formatting up to you.  An \verb|\hfill| command can be used to produce
% a label like ``{\em gnu \hfill --\/}'' where {\em gnu\/} is flush left
% against the margin and the ``--'' is aligned flush right next to the
% item body.

% \item[long]
% The standard \LaTeX\ {\tt description} environment produces a long
% description list.  It italicizes the labels, and puts a period after
% them, which seems to be what is done in the ACM transactions.
% \end{description}

% \subsection{Theorems, Etc.}

% %\newtheorem{theorem}{Theorem}[subsection]
% %\begin{theorem}
% %testing section counter
% %\end{theorem}

% \LaTeX\ provides a single class of theorem-like environments, which are
% defined with the \verb|\newtheorem| command.  The ACM transactions
% style divides this class into two subclasses that are formatted
% differently.  The first class includes theorems, corollaries, lemmas,
% and propositions.  It is produced with the \verb|\newtheorem| command.
% Such a theorem-like environment is often followed by a proof, for which
% the {\tt acmtrans} style provides a {\tt proof} environment.

% \newtheorem{subtheorem}{Theorem}[subsection]
% \begin{subtheorem}
% Notice that theorems are numbered inside the nearest section\newline subsection.
% \end{subtheorem}

% When listing within the theorem environment, this style will now produce
% roman parantheses. Thank you David Sands.

% \begin{proof}	
% This theorem is an instance of {\tt subtheorem}, theorems nested in
% subsections.
% \end{proof}


% The second subclass of theorem-like environments includes ones for
% definitions, examples, and remarks.  These environments are defined
% with the \verb|\newdef| command, which works the same as
% \verb|\newtheorem|.  Here
% is an example of such an environment.

% \newdef{subexample}[subtheorem]{Definition}

% \begin{subexample}
% This is an example of a Definition, typed with an {\tt subexample}
% environment defined with \verb|\newdef|.
% As you can see theorems are italicized and definitions are not.
% \end{subexample}

% \newtheorem{subproperty}[subtheorem]{Property}

% Sometimes theorem-like environments are numbered in unusual ways, or
% are identified by a name.  Consider the following example
% from~\cite{7:3:359}.
% \begin{subproperty}[{\rm Ca}]
% Let syn $\in$ Syn, occ $\in$ Occ be maximal and sta $\in$ Sta.  Then
% Tcol\/{\rm [[}syn\/{\rm ]]} occ sta\hspace{-2pt} $\downarrow\!1$ $=$
% Tsto\/{\rm [[}syn\/{\rm ]]} sta.
% \end{subproperty}
% \begin{proof}[of Property {\rm Ca}]
% By straightforward structural induction, and is \linebreak
% omitted.
% \end{proof}
% It was obtained by giving optional arguments to the
% {\tt property} environment (defined with \verb|\newtheorem|)
% and the {\tt proof} environment and was typed as follows.
% \begin{quote}
% \begin{verbatim}
% \begin{subproperty}[{\rm Ca}] Let ...  \end{subproperty}
% \begin{proof}[of Property {\rm Ca}]  By straightforward ...
% \end{verbatim}
% \end{quote}
% Notice that the optional argument to the {\tt property} environment
% suppresses the automatic numbering.  If a null optional argument
% were given to this environment by typing ``{\tt []}'', then
% it would have produced the label ``{\sc Property.}''  This is
% how unnumbered theorems, etc.\ are produced.

% Environments defined by \verb|\newdef| use the optional
% argument the same way as those defined by \verb|\newtheorem|.

% \vskip10pt
% With this definition

% \begin{verbatim}
%      \newtheorem{secthm}{Theorem}[section]
% \end{verbatim}
% \noindent
% one can solve the counter problems and counter and label problems for
% theorems, lemmas and definitions etc.

% With the above definition and with the following variations
% \begin{verbatim}
%      \newdef{secdefn}[secthm]{Definition} or
%      \newdef{seclem}[secthm]{Lemma} or
%      \newdef{sectheo}{secthm]{Theorem} etc.
% \end{verbatim}
% \noindent
% one can achieve
% \begin{enumerate} 
% \item correct counters in definitions, theorems etc. in \verb|\section| environment.
% For example, to generate ``Definition 4.1.''; without the above two definitions, it produces ``Definition 4.0.1.'' and
% \item correct counter and label associated with definitions, theorems etc. in any environment (section or subsection). For example, 
% \begin{verbatim}
%      \begin{secdefn}[\thesecthm\ (label)] 
%        text text text
%      \end{secdefn}
% \end{verbatim}
% produces the correct definition counter + correct placement of the period as in
% ``Definition 3.1 (label).''.
% \end{enumerate}

% \subsection{Overfull hbox - Stretching/filling one horizontal line}

% To solve a line break due to ``Overfull \verb|\hbox|'', here is a plain \TeX\ 
% solution; here \verb|\hsize| is the default setting of acmtrans.sty:

% \begin{center}
% \verb|\hbox to \hsize{line sentence to be stretched}|
% \end{center}

% This can be used in a list environment as well but \verb|\hsize| declared to a reduce
% dimension:

% \begin{verbatim}
%    \hbox{\vbox{\hsize = less than the default setting
%    \hbox to \hsize{line sentence to be stretched}}}
% \end{verbatim}

% \subsection{Programs}

% Good formatting of programs requires a knowledge of their semantics,
% and is beyond the scope of a document production system.  While
% ``pretty printers'' are useful for handling the many pages of a real
% program, the short examples that are published in articles should be
% formatted by hand to improve their clarity.  The \LaTeX\ {\tt tabbing}
% environment makes the formatting of programs relatively easy,
% especially if the user defines commands for his particular language
% constructs.
% One may also use the {\tt verbatim} environment.

% The ACM transactions style requires that programs be formatted with
% different size fonts, depending upon whether they appear in the text or
% in a figure, but that is handled by the figure macro which
% automatically sets the correct font size.
% %The {\tt acmtrans} style provides a {\tt program}
% %environment that is exactly the same as the standard {\tt tabbing}
% %environment except for the size of the fonts it uses.  This environment
% %should be used for formatting programs, whether they appear in the
% %running text or in a figure.
% Moreover, programs in running text should be indented two ems 
% on each side (as provided by the {\tt quote} environment), and
% programs in regular figures should be centered.
% (Programs in ``narrow figures'' (q.v.) are left or right justified
% automatically).

% Here is an example of a program:
% \begin{quote}
% \begin{tabbing}
% {\bf type} date =\\
% \hspace*{1em}\= {\bf record} \= day: 1\,.\,.\,31;\+\+\\
%                                 month: 1\,.\,.\,12;\\
%                                 year: integer \-\\
%                 {\bf end} \-\\
% {\bf var} mybirth, today : date;\\
% {\bf var} myage : integer;
% \end{tabbing}
% \end{quote}
% Figure~\ref{fig:prog} shows how the same program looks in a figure.
% \begin{figure}
% \centerline{\parbox{104pt}{% it's safe to overestimate the size here
% \begin{tabbing}
% {\bf type} date =\\
% \hspace*{1em}\= {\bf record} \= day: 1\,.\,.\,31;\+\+\\
%                                 month: 1\,.\,.\,12;\\
%                                 year: integer \-\\
%                 {\bf end} \-\\
% {\bf var} mybirth, today : date;\\
% {\bf var} myage : integer;
% \end{tabbing}}}
% \caption{An example of a program centered in a figure}
% \label{fig:prog}
% \end{figure}

% %The ACM standard calls for the program to start flush at the left
% %margin, with each new level of nesting indented by a distance of one
% %em, and with the continuation of broken lines indented two ems.  However,
% %this standard is not applied consistently.

% In addition to formatting programs, the {\tt tabbing} environment may be
% used for similar displayed material such as BNF syntax specifications
% and rewrite rules.

% \subsection{User-specified Formatting}

% If \LaTeX\ does not provide a particular text structure, the user must
% define it himself and specify how it is to be formatted.  This is most
% easily done by defining the new structure in terms of existing ones;
% the \LaTeX\ {\tt list} and {\tt trivlist} environments are useful
% tools.  However, it is occasionally necessary for the user to provide
% explicit formatting commands.  

% The best guide to how something should be formatted is what has been
% done in the ACM transactions.  While horizontal spacing tends to depend
% strongly upon the particular text, there is a standard amount of
% vertical space used to set off text.  The ordinary \LaTeX\ 
% \verb|\medskip| command produces a vertical space of the appropriate
% size.

% \section{Figures and Tables}

% \subsection{Figures}

% The ordinary \LaTeX\ {\tt figure} environment works as usual.
% Figure~\ref{fig:ordinary}, which is Figure~6 of \cite{7:3:359}, a bogus reference,
% \begin{figure}
% \centering
% \(\begin{array}{c|ccc}
%      & \bot & F & T \\
% \hline
% \bot & \bot & \bot & T \\
% F    & \bot & F    & T \\
% T    & \bot & T    & T
% \end{array}\)
% \caption{The truth table for the parallel-or.}
% \label{fig:ordinary}
% \end{figure}
% was produced in this way.
% Note that figures should never appear in the text or at the bottom of
% a page. (If you use the figure placement optional argument, use only
% \verb"t" or \verb"p" or both; do not use \verb"h" or \verb"b").

% Some figures (and tables) have no caption except for the figure number.
% For such figures (and tables), one uses a \verb|\nocaption| command,
% which has no argument, instead of the \verb|\caption| command.

% \begin{narrowfig}{3in}
% \begin{tabbing}
% {\bf type} date =\\
% \hspace*{1em}\= {\bf record} \= day: 1\,.\,.\,31;\+\+\\
%                                 month: 1\,.\,.\,12;\\
%                                 year: integer \-\\
%                 {\bf end} \-\\
% {\bf var} mybirth, today : date;\\
% {\bf var} myage : integer;
% \end{tabbing}
% \caption{An example of a program displayed in a figure.}
% \label{fig:narrow}
% \end{narrowfig}

% In addition to this method of formatting figures, the ACM transactions
% also uses figures with side captions, as in Figure~\ref{fig:narrow}.
% Such a figure is produced with the {\tt narrowfig} environment.  This
% environment has a single mandatory argument, which is the width of the
% figure.
% Note that if the figure is generated by {\tt tabbing} or {\tt
% tabular}, one can safely overestimate the size.
% It works just like the ordinary {\tt figure} environment,
% except it must contain only one \verb|\caption| or \verb|\nocaption|
% command, which must come after the figure itself.  

% The {\tt narrowfig} environment should obviously not be used unless the
% figure is narrow enough to leave a reasonable amount of space beside it
% for the caption.  The ACM seems to have no consistent policy for choosing
% which style of figure to employ.

% \subsection{Tables}

% The ordinary \LaTeX\ {\tt table} environment can be used, but it
% requires the user to add formatting commands to match the ACM
% transactions style.  This formatting is performed automatically
% if the {\tt acmtable} environment is used instead, producing
% the result shown in Table~\ref{tab:table}, which shows the same
% table displayed in Figure~\ref{fig:ordinary}.
% \begin{acmtable}{100pt}
% \centering
% \(\begin{array}{c|ccc}
%      & \bot & F & T \\
% \hline
% \bot & \bot & \bot & T \\
% F    & \bot & F    & T \\
% T    & \bot & T    & T
% \end{array}\)
% \caption{The truth table for the parallel-or.}
% \label{tab:table}
% \end{acmtable}
% This environment has a mandatory argument that equals the width
% of the table---more precisely, it specifies the width of the rules
% above and below the table.  There must be only one 
% \verb|\caption| or \verb|\nocaption|
% command, which must come after the text of the table.  
% (Even though the table caption is printed above the table, the
% \verb|\caption| command comes after the table in the input file.)


% \section{The End of the Document}

% \subsection{Appendix}

% The appendix (if the article has one) should precede the
% acknowledgments (if any) and bibliography.
% If the appendix isn't broken into separate sections,
% then you should add the following commands after the \verb|\appendix|
% command:
% \begin{quote}
% \begin{verbatim}
% \section*{APPENDIX}
% \setcounter{section}{1}
% \end{verbatim}
% \end{quote}
% Setting the counter is necessary so that numbered subsections and
% theorems will have the names ``A.{\em N\/}'' in the text.

% For an article with multiple appendices, one begins
% the appendix with an \verb|\appendix| followed by
% \verb|\section*{APPENDIX}|, and then starts each
% appendix with an ordinary \verb|\section| command.

% Information about electronic appendices is given in
% Section~\ref{sec:elecappendix} and in the Appendix.

% \subsection{Acknowledgments}

% An optional acknowledgments section follows all the text of the
% article, including any appendices.  It is produced with the
% {\tt acks} environment.  (Since I can never remember how many
% {\em e\/}'s there are in {\em acknowledgments}, it seemed
% like an abbreviation was in order for the environment name.
% One may also spell out the name as {\tt acknowledgments}).
% Sometimes, there is just a single acknowledgment.
% This may be given using the {\tt ack} or {\tt acknowledgment}
% environment.

% \subsection{Bibliography}

% The bibliography follows the acknowledgments, and is the last
% significant body of text in the article.  It is produced by the usual
% \LaTeX\ commands. 

% Put
% \begin{quote}
% \begin{verbatim}
% \bibliographystyle{alpha}
% \bibliography{bibliodb}
% \end{verbatim}
% \end{quote}
% between the \verb|\begin{document}| and the \verb|\end{document}|. {\tt bibliodb} 
% refers to the file name of your BibTeX database.

% The conventional \verb|\cite| command will generate citations as usual in
% \LaTeX.

% \subsection{Received Date}

% An ACM transactions article ends with the dates that the article and its
% revised versions were received and the date it was accepted for
% publication.  In the {\tt acmtrans} document style, this information is
% produced with the {\tt received} environment.  Type the body of the
% environment just as it should appear in the printed version.
% (Note that only \verb"Received" and the months should be capitalized,
% the entries should be separated by semicolons,
% and the whole ``sentence'' should {\em not} be terminated by a period.)
% You can get these dates from the editor-in-chief.

% \section{Running Heads and Feet}

% The running foot of all but the title page of the article is declared
% with the \linebreak
% \verb|\runningfoot| command.  It contains the name of the
% journal, volume, number, and date.  The foot for the title page
% contains this information plus the page numbers.  It is declared
% with the \verb|\firstfoot| command.

% The \verb|\pages| command prints the page numbers of the article,
% producing something like ``123--132''.  It is implemented with the
% \LaTeX\ \verb|\pageref| command, so it will not produce the correct
% page numbers the first time the file is run through \LaTeX, or if the
% number of the first or last page has changed since the last time.

% The default page style for the {\tt acmtrans} style is {\tt
% myheadings}.  Thus, a \verb|\markboth| command is used to set the
% running heads.  The left head contains the author's name (or authors'
% names) and the right head contains the title.  For long titles,
% some contraction of the title is used.

% {\bf
% At present, the ACM prefers to strip in their own running heads and
% feet, so it is unnecessary to worry about them when producing
% camera-ready copy.
% }

% \section{Interacting with ACM's Production Staff}

% After your article is accepted, format your document and send
% a Postscript file to the editor-in-chief.  An ACM copy editor will
% mark up a paper copy and send it back to you for corrections.
% If there are just a few corrections, they may be sent to you by e-mail.
% Iterate this process until the copy editor is satisfied (it may take
% one or two iterations).

% Then print your final camera-ready copy on a 1200-dpi phototypesetter
% (or a 600-dpi laser printer, if you must) and mail it to ACM.

% If you are using a laser printer for your final camera-ready copy,
% you may enjoy using special paper designed for this purpose (it gives
% a sharper image on a whiter background).  One such paper
% (manufactured by Hammermill Papers) is:
% \begin{verse}
%    Hammermill Laser Plus (Featuring Wax Holdout)\\
%    8$\frac{1}{2}$x11--12M--S24/60\\
%    10450--5\\
%    For Prepress Proofing and Camera-Ready Masters.
% \end{verse}

% But the use of special paper is entirely optional; plain white laser-printer 
% paper is fine.

% \subsection{ACM Copy Editors' Preferences}

% We wish to thank the authors who have mailed to us copies of their page proofs.
% From the page proofs (and explicit requests from ACM), here is a list of items most 
% frequently marked up by the copy editors. 

% \begin{description}\itemindent\labelsep  % that is, no indentation
% \item[\bf Center] Displayed items like figures, pieces of program codes, and equations.  Equation numbers to appear right flushed. Remember to add a period if the displayed equation ends in a sentence. 
% \item[\bf Fonts] Following items in regular Roman font:
% \begin{itemize}
% \item such words like et al., e.g., i.e., ad hoc, and bona fide, and 
% \item the body of the definition environment.
% \end{itemize} 
% \item[\bf Etc] No double period when a sentence ends with ``etc.''
% \item[\bf Figure] Spell out the word ``figure'' when using in a sentence, as in Figure 1.
% Use a period as in ``Fig. 1.'' and not a colon as in ``Fig. 1:''
% \item[\bf Contractions] Avoid the use of contractions; for example, use 
% {\em do not} instead of {\em don't}.  
% (If you prefer to use contractions to avoid
% stuffiness, you'll have to tell the copy editor explicitly after you
% get the marked-up proofs.)
% \item[\bf Conference References] Please use {\it 4th International Conf. on
% Document Formatting}, not {\it Fourth International Conference ...}; that
% is, do not spell out the number.
% \item[\bf Journal References] Figure~\ref{fig:abbrev} gives common journal abbreviations; there is a duplicate list in the acmtrans.bst file for your convenience.  Using the {\it abbreviation} feature of   for journal
% names (and months!) makes it easy to follow the rules.
% \end{description} 

% \begin{figure}\noindent
% \begin{tabular}{l|l||l|l}
% \footnotesize
% acmcs&ACM Comput. Surv.&jlp&J. Logic Program.\\
% acmlett&ACM Lett. Program. Lang. Syst.&jcss&J. Comput. Syst. Sci.\\
% acta&Acta Inf.&jsmrp&J. Softw. Maint. Res. Pract.\\
% al&Ada Lett.&jss&J. Syst. Softw.\\
% acr&Adv. Comput. Res.&jlsc&J. Lisp Symb. Comput.\\
% bit&Bit&lpls&Lett. Program. Lang. Syst.\\
% cacm&Commun. ACM&mscs&Math. Struct. Comput. Sci.\\
% cj&Comput. J.&mst&Math. Syst. Theor.\\
% cn&Comput. J.&ngc&New Gen. Comput.\\
% cl&Comput. Lang.&scp&Sci. Comput. Program.\\
% ict&Inf. Contr.&sicomp&SIAM J. Comput.\\
% ieebcs&IEE/BCS Softw. Eng. J.&spe&Softw. Pract. Exper.\\
% ieees&IEEE Softw.&tocs&ACM Trans. Comput. Syst.\\
% ieeese&IEEE Trans. Softw. Eng.&tods&ACM Trans. Database Syst.\\
% ieeetc&IEEE Trans. Comput.&tog&ACM Trans. Graphics\\
% ieeetpds&IEEE Trans. Parall. Distrib. Syst.&toms&ACM Trans. Math. Softw.\\
% ieeetit&IEEE Trans. Inf. Theory&toois&ACM Trans. Office Inf. Syst.\\
% ipl&Inf. Process. Lett.&toplas&ACM Trans. Program. Lang. Syst.\\
% icp&Inf. Comput.&tcs&Theor. Comput. Sci.\\
% ist&Inf. Softw. Tech.&tr&Tech. Rep.\\
% ijsa&Int. J. Supercomput. Appl.&jf&J. Funct. Program.\\
% ijpp&Int. J. Parallel Program.&jlc&J. Logic and Comput.\\
% \end{tabular}
% \caption{Common journal abbreviations.}
% \label{fig:abbrev}
% \end{figure}

% The best method of
% reducing the number of copy editorial markups is by using a recent ACM journal 
% as a guide  to typesetting your article.  

% \section{Electronic Appendices}
% \label{sec:elecappendix}

% Because of severe constraints on how many pages it can print,
% {\it ACM Transactions on Programming Languages and Systems} (TOPLAS)
% accepts some articles with {\it electronic appendices:}  appendices
% in Postscript format that will not appear in the printed article but
% will be available separately.  If your article is accepted with an
% electronic appendix, you should put an appendix header where the
% appendix normally belongs (before the ``acknowledgments'').
% The body of the electronic appendix should be given after the
% references.
% The \verb|appendixhead| command is given
% \begin{quote}
% {\tt \verb|\|appendixhead\{{\it journal}\}\{{\it article-id}\}}
% \end{quote}
% where {\it journal} is the name of the journal (e.g. {\tt toplas} or
% {\tt todf}), and
% {\it article-id} is a number given to you by the Editor.
% The result of \verb|\appendixhead| looks like this:\footnote{%
% See the end of this document for the remainder of the explanation of
% electronic appendices}

% \nocite{*}


% \appendix
% \section*{ONLINE-ONLY APPENDICES}
% \setcounter{secnumbookdepth}{-1}
% % \begin{NoHyper}
% \section{Splitting off the electronic appendix}
% \section{Single appendix}
% \section{Multiple appendices}
% % \end{NoHyper}
% \setcounter{secnumbookdepth}{3}

% \appendixhead{Appendix A is}{appendix}{http://www.acm.org/toplas}

% \begin{acks}
% We wish to thank Howard Trickey for providing the now-obsolete
% version of the {\tt acmtrans}
% bibliography style, and for giving advice on creating the new one;
% Rebecca Davies for helping to adapt
% Glenn Paulley's ``Chicago'' bibliography
% style to fit the new ACM style; 
% and Marilyn Salmansohn and George Criscione for providing information
% on the official ACM transactions style.
% \end{acks}

% \begin{received}
% Received February 1986;
% November 1993;
% accepted January 1996
% \end{received}

% \elecappendix{http://www.acm.org/toplas}{1998}{ACM Transactions on Document Formatting,
%      Vol.~8, No.~1, January 1999, Pages \pages.}{
% \copyright\ 1999 ACM 0164-0925/98/0100-0208A \$5.00}

% The contents of the electronic appendix is written after the references
% and the ``received'' environment.
% The electronic appendix is started 
% by an \verb|\elecappendix| command that takes two
% required arguments:
% \begin{quote}
% {\tt \verb|\|elecappendix\{{\it year}\}\{{\it ref\/}\}}
% \end{quote}
% where
% {\it year} is the year of appearance (or, if this not known, the year
% of acceptance), necessary for the copyright notice, and
% {\it ref\/} is a sentence provided by the Editor describing the
% publication reference
% information regarding your article.

% \section{Splitting off the electronic appendix}

% If you have an electronic appendix, only the main body of the
% article, up through and including the description of how to obtain
% the electronic appendix, will be printed in the journal.

% It will be necessary to split your dvi or Postscript file into
% two parts: one to be printed, the other to be available by
% FTP.  Please split your Postscript into two separate postscript files 
% using {\tt dvipages} or {\tt pslpr} and
% email them separately to the Editor.

% Note that the pages of the appendix are numbered A-1, A-2, etc.
% so as not to interfere with the normal journal pagination.

% \section{Single Appendix}

% When an article has a single electronic appendix, then after
% the \verb|\elecappendix| command, type the following.
% \begin{quote}
% \begin{verbatim}
% \setcounter{section}{1}
% \end{verbatim}
% \end{quote}
% If the text starts immediately, add a \verb|\medskip| to set off the
% text from the horizontal rule created by \verb|\elecappendix|.

% \section{Multiple appendices}

% For an article with multiple electronic appendices, one begins
% the appendix with an \verb|\elecappendix|
% command, then starts each
% appendix with an ordinary \verb|\section| command.  Lower levels of
% sectioning are produced by the ordinary sectioning commands.

\end{document}






%%% Local Variables:
%%% mode: latex
%%% TeX-master: "sheaf_jfr"
%%% End:
